<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MMORPG</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1d23;--card:#23272f;--border:#363b44;--text:#e8e6e3;--dim:#9a9fa8;--muted:#5c6370;--accent:#c9a227;--hp:#c94a4a;--xp:#8b5cf6;--ok:#4ade80;--bad:#ef4444;--warn:#f59e0b}
html,body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;height:100%;width:100%}
body{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none}
.hdr{background:var(--card);padding:10px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.avatar{width:40px;height:40px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid var(--accent)}
.hdr-info{flex:1}.hdr-name{font-weight:600;font-size:14px}
.bar{height:6px;background:#3d2a2a;border-radius:3px;margin-top:4px}.bar-fill{height:100%;border-radius:3px;transition:width .3s}.bar-hp{background:var(--hp)}
.gold{display:flex;align-items:center;gap:4px;color:var(--accent);font-weight:600}
.main{flex:1;overflow-y:auto;padding:12px;padding-bottom:70px}
.screen{display:none}.screen.active{display:block}
.card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border)}
.card-title{font-size:12px;font-weight:600;color:var(--dim);text-transform:uppercase;margin-bottom:10px}
.btn{padding:10px 14px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn-p{background:var(--accent);color:#000}.btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-d{background:var(--bad);color:#fff}.btn:disabled{opacity:.4;cursor:not-allowed}.btn-sm{padding:6px 10px;font-size:12px}
.tabs{display:flex;gap:4px;margin-bottom:12px;background:var(--bg);padding:4px;border-radius:8px}
.tab{flex:1;padding:8px;background:none;border:none;border-radius:6px;color:var(--dim);font-size:12px;cursor:pointer}.tab.active{background:var(--card);color:var(--text)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-ok{background:rgba(74,222,128,.2);color:var(--ok)}.badge-warn{background:rgba(245,158,11,.2);color:var(--warn)}.badge-bad{background:rgba(239,68,68,.2);color:var(--bad)}
.map-view{position:relative;height:200px;background:var(--bg);border-radius:8px;overflow:hidden;margin-bottom:10px}
.map-node{position:absolute;width:24px;height:24px;background:var(--card);border:2px solid var(--border);border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
.map-node.current{border-color:var(--accent);background:var(--accent);color:#000}
.map-node.exit{border-color:var(--ok)}
.map-path{position:absolute;background:var(--border);height:2px;transform-origin:left center}
.map-player{position:absolute;font-size:16px;transform:translate(-50%,-50%);z-index:10;transition:all .5s}
.step-btn{width:100%;padding:14px;position:relative;overflow:hidden}
.step-prog{position:absolute;left:0;top:0;height:100%;background:rgba(255,255,255,.2);width:0;transition:width .1s linear}
.event{text-align:center;padding:16px}
.event-icon{width:64px;height:64px;margin:0 auto 12px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;border:2px solid var(--border)}
.event-icon.enemy{border-color:var(--bad)}.event-icon.res{border-color:var(--ok)}.event-icon.player{border-color:var(--xp)}
.event-title{font-size:16px;font-weight:700;margin-bottom:6px}
.event-stats{display:flex;justify-content:center;gap:12px;font-size:13px;color:var(--dim);margin:8px 0}
.event-acts{display:flex;gap:6px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.gather-btn{width:100%;padding:16px;position:relative;touch-action:none}
.gather-prog{height:4px;background:var(--bg);border-radius:2px;margin-top:8px;overflow:hidden}
.gather-prog-fill{height:100%;background:var(--ok);transition:width .05s linear}
.combat{background:linear-gradient(180deg,#2a1f1f,var(--card));border-color:var(--bad)}
.fighter{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px}
.fighter-ava{width:44px;height:44px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px}
.fighter-info{flex:1}.fighter-name{font-weight:600;font-size:13px;margin-bottom:4px}
.fighter-hp{height:10px;background:#3d2a2a;border-radius:5px;overflow:hidden;position:relative}
.fighter-hp-fill{height:100%;background:linear-gradient(90deg,#b91c1c,var(--hp));transition:width .3s}
.fighter-hp-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;font-weight:700}
.abilities{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px}
.abil-btn{padding:10px 8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left}
.abil-btn:hover{border-color:var(--accent)}.abil-btn:disabled{opacity:.5}
.abil-name{font-weight:600;font-size:12px}.abil-desc{font-size:10px;color:var(--muted)}
.turn-indicator{text-align:center;padding:8px;font-size:12px;color:var(--accent);font-weight:600}
.log{max-height:80px;overflow-y:auto;background:var(--bg);border-radius:6px;padding:8px;margin-top:10px;font-size:11px}
.log-dmg{color:var(--bad)}.log-heal{color:var(--ok)}
.inv-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.inv-slot{aspect-ratio:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;font-size:20px;position:relative}
.inv-slot:hover{border-color:var(--accent)}.inv-slot.empty{opacity:.3;cursor:default}
.inv-slot.eq{border-color:var(--accent);background:rgba(201,162,39,.1)}
.inv-slot .eq-dot{position:absolute;top:3px;right:3px;width:6px;height:6px;background:var(--accent);border-radius:50%}
.inv-slot .name{font-size:8px;color:var(--dim);text-align:center;line-height:1.1;margin-top:2px}
.eq-panel{display:flex;justify-content:center;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.eq-slot{width:48px;height:48px;background:var(--bg);border:1px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--muted)}
.eq-slot.filled{border-style:solid;border-color:var(--accent);color:var(--text)}
.res-bar{display:flex;gap:4px;flex-wrap:wrap}
.res-item{display:flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg);border-radius:6px;font-size:12px}
.loc-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;cursor:pointer}
.loc-item:hover{border-color:var(--accent)}.loc-item.current{border-color:var(--ok)}
.craft-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:10px;margin-bottom:6px}
.craft-icon{width:40px;height:40px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.craft-info{flex:1}.craft-name{font-weight:600;font-size:13px}
.craft-reqs{display:flex;gap:6px;font-size:11px;margin-top:2px;flex-wrap:wrap}
.craft-req{padding:2px 5px;background:var(--card);border-radius:3px}.craft-req.ok{color:var(--ok)}.craft-req.no{color:var(--bad)}
.mast-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px}
.mast-icon{width:36px;height:36px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px}
.mast-info{flex:1}.mast-head{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}.mast-lv{color:var(--xp);font-weight:600}
.mast-bar{height:4px;background:var(--bg);border-radius:2px}.mast-bar-fill{height:100%;background:var(--xp);border-radius:2px}
.auc-filters{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.auc-filters select,.auc-filters input{padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}
.auc-filters input[type=text]{flex:1;min-width:80px}
.auc-group{background:var(--bg);border-radius:8px;margin-bottom:6px;overflow:hidden}
.auc-group-head{display:flex;align-items:center;gap:8px;padding:10px;cursor:pointer}
.auc-group-head:hover{background:var(--card)}
.auc-icon{width:32px;height:32px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px}
.auc-group-info{flex:1}.auc-group-name{font-weight:600;font-size:13px}.auc-group-meta{font-size:10px;color:var(--muted)}
.auc-group-price{color:var(--accent);font-weight:600;font-size:13px}
.auc-orders{padding:0 10px 10px;display:none}.auc-orders.open{display:block}
.auc-order{display:flex;align-items:center;gap:8px;padding:6px;background:var(--card);border-radius:6px;margin-bottom:4px;font-size:12px}
.auc-order-info{flex:1}.auc-order-price{color:var(--accent)}
.bank-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal.active{display:flex}
.modal-box{background:var(--card);border-radius:12px;padding:16px;width:100%;max-width:320px;max-height:80vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.modal-title{font-size:16px;font-weight:700}.modal-close{width:28px;height:28px;background:var(--bg);border:none;border-radius:6px;color:var(--dim);cursor:pointer;font-size:16px}
.nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:var(--card);border-top:1px solid var(--border);display:flex;padding:6px}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px;background:none;border:none;color:var(--muted);cursor:pointer;border-radius:6px;font-size:10px}.nav-item.active{color:var(--accent)}
.toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--dim)}
.toggle input{width:36px;height:20px;appearance:none;background:var(--bg);border-radius:10px;position:relative;cursor:pointer}
.toggle input::after{content:'';position:absolute;width:16px;height:16px;background:var(--dim);border-radius:50%;top:2px;left:2px;transition:.2s}
.toggle input:checked{background:var(--accent)}.toggle input:checked::after{left:18px;background:#fff}
</style>
</head>
<body>
<div class="hdr">
<div class="avatar" id="avatar">üë§</div>
<div class="hdr-info"><div class="hdr-name" id="hdrName">–ò–≥—Ä–æ–∫</div><div class="bar"><div class="bar-fill bar-hp" id="hdrHp" style="width:100%"></div></div></div>
<div class="gold">üí∞ <span id="hdrGold">150</span></div>
</div>
<div class="main">
<div class="screen active" id="sExplore">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div><span id="locName" style="font-weight:700">–õ—É–≥–∞</span> <span class="badge badge-warn" id="locBadge">PvP</span></div>
<span style="font-size:11px;color:var(--dim)" id="locTier">–£—Ä.1</span>
</div>
<div class="map-view" id="mapView"></div>
<button class="btn btn-p step-btn" id="stepBtn" onmousedown="startStepAuto()" onmouseup="stopStep()" onmouseleave="stopStep()" ontouchstart="startStepAuto()" ontouchend="stopStep()">
<span class="step-prog" id="stepProg"></span>
<span id="stepText">üö∂ –°–¥–µ–ª–∞—Ç—å —à–∞–≥</span>
</button>
</div>
<div class="card event" id="eventCard"></div>
<div class="card combat" id="combatCard" style="display:none">
<div class="fighter"><div class="fighter-ava" id="cEnemyAva">üê∫</div><div class="fighter-info"><div class="fighter-name" id="cEnemyName">–í–æ–ª–∫</div><div class="fighter-hp"><div class="fighter-hp-fill" id="cEnemyHp"></div><span class="fighter-hp-text" id="cEnemyHpTxt"></span></div></div></div>
<div class="turn-indicator" id="turnInd">–í–∞—à —Ö–æ–¥</div>
<div class="fighter"><div class="fighter-ava">üë§</div><div class="fighter-info"><div class="fighter-name">–í—ã</div><div class="fighter-hp"><div class="fighter-hp-fill" id="cPlayerHp"></div><span class="fighter-hp-text" id="cPlayerHpTxt"></span></div></div></div>
<div class="abilities" id="abilGrid"></div>
<div class="log" id="combatLog"></div>
</div>
</div>
<div class="screen" id="sInv">
<div class="card"><div class="card-title">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div><div class="eq-panel" id="eqPanel"></div></div>
<div class="card"><div class="card-title">–†–µ—Å—É—Ä—Å—ã</div><div class="res-bar" id="resBar"></div></div>
<div class="card"><div class="card-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div class="inv-grid" id="invGrid"></div></div>
</div>
<div class="screen" id="sMap"><div class="card"><div class="card-title">–õ–æ–∫–∞—Ü–∏–∏</div><div id="locList"></div></div></div>
<div class="screen" id="sCity">
<div class="tabs" id="cityTabs"><button class="tab active" onclick="cityTab('craft')">–ö—Ä–∞—Ñ—Ç</button><button class="tab" onclick="cityTab('bank')">–ë–∞–Ω–∫</button><button class="tab" onclick="cityTab('auc')">–ê—É–∫—Ü–∏–æ–Ω</button></div>
<div id="cityContent"></div>
</div>
<div class="screen" id="sMast"><div class="card"><div class="card-title">–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</div><div id="mastList"></div></div></div>
</div>
<div class="nav">
<button class="nav-item active" onclick="nav('Explore',this)">üåç<span>–ú–∏—Ä</span></button>
<button class="nav-item" onclick="nav('Inv',this)">üéí<span>–°—É–º–∫–∞</span></button>
<button class="nav-item" onclick="nav('Map',this)">üó∫Ô∏è<span>–ö–∞—Ä—Ç–∞</span></button>
<button class="nav-item" onclick="nav('City',this)">üè∞<span>–ì–æ—Ä–æ–¥</span></button>
<button class="nav-item" onclick="nav('Mast',this)">üìä<span>–°–∫–∏–ª—ã</span></button>
</div>
<div class="modal" id="modal"><div class="modal-box"><div class="modal-head"><div class="modal-title" id="modTitle"></div><button class="modal-close" onclick="closeMod()">√ó</button></div><div id="modContent"></div></div></div>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
let tg = null;
if (window.Telegram?.WebApp) {
  tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.setHeaderColor('#23272f');
  tg.setBackgroundColor('#1a1d23');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ localStorage
function loadSave() {
  const saved = localStorage.getItem('mmorpg_save');
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch(e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
  }
  // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  return {p:{hp:100,maxHp:100,gold:150,res:{wood:8,metal:5,cloth:3,leather:4},inv:['wooden_sword','leather_armor','pickaxe','axe','sickle','skinning_knife'],eq:{mainHand:null,offHand:null,chest:null,boots:null,tool:null},bank:{res:{wood:10,metal:0,cloth:0,leather:0},items:['cloth_robe']},mast:{sword:{lv:3,xp:45},bow:{lv:1,xp:0},staff:{lv:2,xp:80},cloth:{lv:1,xp:20},leather:{lv:2,xp:10},plate:{lv:1,xp:0}}},loc:'meadow',node:0,combat:null,event:null,turn:'player',gatherLeft:0};
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
function saveGame() {
  localStorage.setItem('mmorpg_save', JSON.stringify(S));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏–∑ Telegram
function updatePlayerName() {
  if (tg?.initDataUnsafe?.user) {
    const user = tg.initDataUnsafe.user;
    $('hdrName').textContent = user.first_name || '–ò–≥—Ä–æ–∫';
    $('avatar').textContent = user.first_name?.[0] || 'üë§';
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
let S = loadSave();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
  try {
    updatePlayerName();
    updHdr();
    renderMap();
    genEvent();
    console.log('–ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
  } catch(e) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
    document.body.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text)"><h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2><p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p></div>';
  }
});

const LOCS={city:{name:'–ì–æ—Ä–æ–¥',icon:'üè∞',tier:0,pvp:'safe',isCity:1,nodes:[{x:50,y:50}],paths:[],exits:{}},meadow:{name:'–õ—É–≥–∞',icon:'üåø',tier:1,pvp:'request',nodes:[{x:20,y:80},{x:40,y:60},{x:60,y:40},{x:50,y:70},{x:80,y:30}],paths:[[0,1],[1,2],[1,3],[2,4],[3,4]],enemies:['slime','wolf'],res:['wood','cloth'],exits:{4:'forest'}},forest:{name:'–õ–µ—Å',icon:'üå≤',tier:2,pvp:'request',nodes:[{x:20,y:30},{x:40,y:50},{x:30,y:70},{x:60,y:40},{x:80,y:60},{x:70,y:80}],paths:[[0,1],[1,2],[1,3],[3,4],[2,5],[4,5]],enemies:['wolf','bear'],res:['wood','leather'],exits:{0:'meadow',5:'highlands'}},highlands:{name:'–í—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ',icon:'‚õ∞Ô∏è',tier:3,pvp:'open',nodes:[{x:50,y:20},{x:30,y:40},{x:70,y:40},{x:40,y:60},{x:60,y:60},{x:50,y:80}],paths:[[0,1],[0,2],[1,3],[2,4],[3,5],[4,5]],enemies:['golem','harpy'],res:['metal','leather'],exits:{0:'forest'}}};
const ENEMIES={slime:{name:'–°–ª–∏–∑–µ–Ω—å',icon:'üü¢',hp:30,dmg:5,xp:10,loot:['cloth']},wolf:{name:'–í–æ–ª–∫',icon:'üê∫',hp:50,dmg:10,xp:20,loot:['leather']},bear:{name:'–ú–µ–¥–≤–µ–¥—å',icon:'üêª',hp:80,dmg:15,xp:35,loot:['leather','leather']},golem:{name:'–ì–æ–ª–µ–º',icon:'üóø',hp:120,dmg:18,xp:50,loot:['metal','metal']},harpy:{name:'–ì–∞—Ä–ø–∏—è',icon:'ü¶Ö',hp:60,dmg:20,xp:45,loot:['cloth']}};
const PLAYERS=[{name:'–†—ã—Ü–∞—Ä—å_42',hp:80,dmg:15,loot:['iron_sword']},{name:'MagicUser',hp:60,dmg:20,loot:['wooden_staff']},{name:'–û—Ö–æ—Ç–Ω–∏–∫',hp:70,dmg:18,loot:['wooden_bow']}];
const TOOLS={pickaxe:{name:'–ö–∏—Ä–∫–∞',icon:'‚õèÔ∏è',for:'metal'},axe:{name:'–¢–æ–ø–æ—Ä',icon:'ü™ì',for:'wood'},sickle:{name:'–°–µ—Ä–ø',icon:'üåæ',for:'cloth'},skinning_knife:{name:'–ù–æ–∂ —Å–≤–µ–∂–µ–≤–∞—Ç–µ–ª—è',icon:'üî™',for:'leather'}};
const ITEMS={wooden_sword:{name:'–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á',icon:'üó°Ô∏è',slot:'mainHand',ab:['slash','block'],cat:'sword',desc:'–ë–∞–∑–æ–≤–æ–µ –æ—Ä—É–∂–∏–µ'},iron_sword:{name:'–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á',icon:'‚öîÔ∏è',slot:'mainHand',ab:['slash','parry'],cat:'sword',desc:'–£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ—á'},wooden_bow:{name:'–õ—É–∫',icon:'üèπ',slot:'mainHand',ab:['shoot','multishot'],cat:'bow',two:1,desc:'–°—Ç—Ä–µ–ª—è–µ—Ç –∏–∑–¥–∞–ª–µ–∫–∞'},wooden_staff:{name:'–ü–æ—Å–æ—Ö',icon:'ü™Ñ',slot:'mainHand',ab:['fireball','heal'],cat:'staff',two:1,desc:'–ú–∞–≥–∏—á–µ—Å–∫–æ–µ –æ—Ä—É–∂–∏–µ'},wooden_shield:{name:'–©–∏—Ç',icon:'üõ°Ô∏è',slot:'offHand',ab:['shieldblock'],cat:'shield',desc:'–ë–ª–æ–∫–∏—Ä—É–µ—Ç —É—Ä–æ–Ω'},cloth_robe:{name:'–†–æ–±–∞',icon:'üëò',slot:'chest',ab:['mana_shield'],cat:'cloth',desc:'–ú–∞–≥–∏—á–µ—Å–∫–∞—è –±—Ä–æ–Ω—è'},leather_armor:{name:'–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è',icon:'ü¶∫',slot:'chest',ab:['dodge'],cat:'leather',desc:'–ë–∞–ª–∞–Ω—Å –∑–∞—â–∏—Ç—ã'},plate_armor:{name:'–õ–∞—Ç—ã',icon:'üõ°Ô∏è',slot:'chest',ab:['fortify'],cat:'plate',desc:'–ú–∞–∫—Å. –∑–∞—â–∏—Ç–∞'},cloth_boots:{name:'–¢–∫–∞–Ω–µ–≤—ã–µ —Å–∞–ø–æ–≥–∏',icon:'üëü',slot:'boots',ab:['blink'],cat:'cloth',desc:'–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è'},leather_boots:{name:'–ö–æ–∂–∞–Ω—ã–µ —Å–∞–ø–æ–≥–∏',icon:'ü•æ',slot:'boots',ab:['dash'],cat:'leather',desc:'–ë—ã—Å—Ç—Ä—ã–π —Ä—ã–≤–æ–∫'},plate_boots:{name:'–õ–∞—Ç–Ω—ã–µ —Å–∞–ø–æ–≥–∏',icon:'ü¶∂',slot:'boots',ab:['stomp'],cat:'plate',desc:'–û–≥–ª—É—à–∞—é—â–∏–π —É–¥–∞—Ä'},pickaxe:{name:'–ö–∏—Ä–∫–∞',icon:'‚õèÔ∏è',slot:'tool',ab:[],cat:'tool',desc:'–î–ª—è –¥–æ–±—ã—á–∏ —Ä—É–¥—ã'},axe:{name:'–¢–æ–ø–æ—Ä',icon:'ü™ì',slot:'tool',ab:[],cat:'tool',desc:'–î–ª—è —Ä—É–±–∫–∏ –¥–µ—Ä–µ–≤–∞'},sickle:{name:'–°–µ—Ä–ø',icon:'üåæ',slot:'tool',ab:[],cat:'tool',desc:'–î–ª—è —Å–±–æ—Ä–∞ –≤–æ–ª–æ–∫–æ–Ω'},skinning_knife:{name:'–ù–æ–∂ —Å–≤–µ–∂–µ–≤–∞—Ç–µ–ª—è',icon:'üî™',slot:'tool',ab:[],cat:'tool',desc:'–î–ª—è —Å–Ω—è—Ç–∏—è –∫–æ–∂–∏'}};
const ABILS={punch:{name:'–£–¥–∞—Ä',icon:'üëä',dmg:5,desc:'–ë–µ–∑ –æ—Ä—É–∂–∏—è'},wait:{name:'–ñ–¥–∞—Ç—å',icon:'‚è≥',heal:5,desc:'+5 HP'},slash:{name:'–†—É–±—è—â–∏–π',icon:'‚öîÔ∏è',dmg:15,desc:'15 —É—Ä–æ–Ω–∞'},block:{name:'–ë–ª–æ–∫',icon:'üõ°Ô∏è',def:20,desc:'20 –∑–∞—â–∏—Ç—ã'},parry:{name:'–ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ',icon:'‚Ü©Ô∏è',dmg:10,def:10,desc:'10 —É—Ä–æ–Ω–∞, 10 –∑–∞—â–∏—Ç—ã'},shoot:{name:'–í—ã—Å—Ç—Ä–µ–ª',icon:'üèπ',dmg:18,desc:'18 —É—Ä–æ–Ω–∞'},multishot:{name:'–ó–∞–ª–ø',icon:'üéØ',dmg:24,desc:'24 —É—Ä–æ–Ω–∞'},fireball:{name:'–û–≥–Ω–µ—à–∞—Ä',icon:'üî•',dmg:25,desc:'25 —É—Ä–æ–Ω–∞'},heal:{name:'–õ–µ—á–µ–Ω–∏–µ',icon:'üíö',heal:30,desc:'+30 HP'},shieldblock:{name:'–ë–ª–æ–∫ —â–∏—Ç–æ–º',icon:'üõ°Ô∏è',def:25,desc:'25 –∑–∞—â–∏—Ç—ã'},mana_shield:{name:'–ú–∞–Ω–∞-—â–∏—Ç',icon:'üîÆ',def:25,desc:'25 –∑–∞—â–∏—Ç—ã'},dodge:{name:'–£–∫–ª–æ–Ω–µ–Ω–∏–µ',icon:'üí®',evade:1,desc:'–ò–∑–±–µ–∂–∞—Ç—å —É–¥–∞—Ä–∞'},fortify:{name:'–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ',icon:'üè∞',def:30,desc:'30 –∑–∞—â–∏—Ç—ã'},blink:{name:'–¢–µ–ª–µ–ø–æ—Ä—Ç',icon:'‚ú®',dmg:15,evade:1,desc:'15 —É—Ä–æ–Ω–∞ + —É–∫–ª–æ–Ω'},dash:{name:'–†—ã–≤–æ–∫',icon:'üí®',dmg:12,desc:'12 —É—Ä–æ–Ω–∞'},stomp:{name:'–¢–æ–ø–æ—Ç',icon:'üí•',dmg:20,desc:'20 —É—Ä–æ–Ω–∞'}};
const RECIPES={wooden_sword:{wood:2,metal:1},iron_sword:{metal:4,wood:1},wooden_bow:{wood:3},wooden_staff:{wood:2,cloth:1},wooden_shield:{wood:2,leather:1},cloth_robe:{cloth:4},leather_armor:{leather:4},plate_armor:{metal:4,leather:2},cloth_boots:{cloth:2},leather_boots:{leather:2},plate_boots:{metal:2,leather:1},pickaxe:{wood:1,metal:2},axe:{wood:1,metal:2},sickle:{wood:1,metal:1},skinning_knife:{wood:1,metal:1}};
const RES_ICON={wood:'ü™µ',metal:'üß±',cloth:'üß∂',leather:'ü¶¥'};
const RES_TOOL={wood:'axe',metal:'pickaxe',cloth:'sickle',leather:'skinning_knife'};
let AUC=[{id:1,item:'iron_sword',price:100,seller:'–¢–æ—Ä–≥–æ–≤–µ—Ü'},{id:2,item:'iron_sword',price:120,seller:'–ö—É–∑–Ω–µ—Ü'},{id:3,item:'plate_armor',price:200,seller:'–ö—É–∑–Ω–µ—Ü'},{id:4,item:'leather_boots',price:50,seller:'–û—Ö–æ—Ç–Ω–∏–∫'},{id:5,item:'leather_boots',price:45,seller:'–°–∫–æ—Ä–Ω—è–∫'},{id:6,item:'wooden_bow',price:40,seller:'–õ—É—á–Ω–∏–∫'}];
let aucId=7,aucFilter='all',aucSort='price',aucSearch='',aucExec=false;
let stepInterval=null,stepProgress=0,gatherInterval=null,gatherProgress=0;
const $=id=>document.getElementById(id);
function updHdr(){$('hdrHp').style.width=(S.p.hp/S.p.maxHp*100)+'%';$('hdrGold').textContent=S.p.gold;saveGame()}
function nav(s,btn){document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));$('s'+s).classList.add('active');document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));btn.classList.add('active');if(s==='Inv')renderInv();if(s==='Map')renderLocList();if(s==='City')renderCity();if(s==='Mast')renderMast()}
function renderMap(){const L=LOCS[S.loc],mv=$('mapView');$('locName').textContent=L.name;$('locTier').textContent=L.isCity?'–ì–æ—Ä–æ–¥':'–£—Ä.'+L.tier;const b=$('locBadge');b.className='badge '+(L.pvp==='safe'?'badge-ok':L.pvp==='request'?'badge-warn':'badge-bad');b.textContent=L.pvp==='safe'?'–ë–µ–∑–æ–ø–∞—Å–Ω–æ':L.pvp==='request'?'PvP –∑–∞–ø—Ä–æ—Å':'‚ö†Ô∏è PvP';
let h='';L.paths.forEach(([a,b])=>{const n1=L.nodes[a],n2=L.nodes[b],dx=n2.x-n1.x,dy=n2.y-n1.y,len=Math.sqrt(dx*dx+dy*dy),ang=Math.atan2(dy,dx)*180/Math.PI;h+=`<div class="map-path" style="left:${n1.x}%;top:${n1.y}%;width:${len}%;transform:rotate(${ang}deg)"></div>`});
L.nodes.forEach((n,i)=>{const cur=i===S.node,exit=L.exits&&L.exits[i];h+=`<div class="map-node${cur?' current':''}${exit?' exit':''}" style="left:${n.x}%;top:${n.y}%">${i+1}</div>`});
h+=`<div class="map-player" id="mapPlayer" style="left:${L.nodes[S.node].x}%;top:${L.nodes[S.node].y}%">üë§</div>`;
mv.innerHTML=h;updStepBtn()}
function getAdj(){const L=LOCS[S.loc];return L.paths.filter(([a,b])=>a===S.node||b===S.node).map(([a,b])=>a===S.node?b:a)}
function updStepBtn(){const L=LOCS[S.loc],adj=getAdj(),exit=L.exits&&L.exits[S.node];if(L.isCity){$('stepBtn').style.display='none';return}$('stepBtn').style.display='';if(exit){$('stepText').textContent='‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏: '+LOCS[exit].name;$('stepBtn').onclick=()=>goTo(exit);$('stepBtn').onmousedown=$('stepBtn').ontouchstart=null}else if(adj.length===1){$('stepText').textContent='üö∂ –°–¥–µ–ª–∞—Ç—å —à–∞–≥';$('stepBtn').onclick=null;$('stepBtn').onmousedown=$('stepBtn').ontouchstart=()=>startStep(adj[0])}else{$('stepText').textContent='üîÄ –í—ã–±—Ä–∞—Ç—å –ø—É—Ç—å';$('stepBtn').onclick=()=>showFork(adj);$('stepBtn').onmousedown=$('stepBtn').ontouchstart=null}}
function showFork(adj){$('modTitle').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å';$('modContent').innerHTML=adj.map(n=>`<button class="btn btn-s" style="width:100%;margin-bottom:6px" onclick="closeMod();startStep(${n})">–£–∑–µ–ª ${n+1}</button>`).join('');$('modal').classList.add('active')}
function startStepAuto(){const adj=getAdj();if(adj.length===1)startStep(adj[0])}
function startStep(target){if(stepInterval||S.combat)return;stepProgress=0;stepInterval=setInterval(()=>{stepProgress+=50;$('stepProg').style.width=(stepProgress/2000*100)+'%';if(stepProgress>=2000){stopStep();S.node=target;saveGame();renderMap();genEvent()}},50)}
function stopStep(){if(stepInterval){clearInterval(stepInterval);stepInterval=null;stepProgress=0;$('stepProg').style.width='0'}}
function goTo(loc){S.loc=loc;S.node=0;renderMap();saveGame();if(LOCS[loc].isCity)$('eventCard').innerHTML=`<div class="event-icon res">üè∞</div><div class="event-title">–ì–æ—Ä–æ–¥</div><p style="color:var(--dim);margin-top:8px">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ì–æ—Ä–æ–¥" –≤ –º–µ–Ω—é</p>`;else genEvent()}
function genEvent(){const L=LOCS[S.loc];if(L.isCity)return;const r=Math.random(),c=$('eventCard');S.event=null;
if(r<.3&&L.enemies?.length){const ek=L.enemies[Math.floor(Math.random()*L.enemies.length)],e=ENEMIES[ek];S.event={type:'enemy',key:ek,data:e};c.innerHTML=`<div class="event-icon enemy">${e.icon}</div><div class="event-title">${e.name}</div><div class="event-stats"><span style="color:var(--hp)">‚ù§Ô∏è${e.hp}</span><span style="color:var(--bad)">‚öîÔ∏è${e.dmg}</span></div><div class="event-acts"><button class="btn btn-p" onclick="startCombat()">‚öîÔ∏è –ë–æ–π</button><button class="btn btn-s" onclick="genEvent()">–£–±–µ–∂–∞—Ç—å</button></div>`}
else if(r<.55&&L.res?.length){const rt=L.res[Math.floor(Math.random()*L.res.length)];S.event={type:'res',rt,left:4};S.gatherLeft=4;renderGather()}
else if(r<.7&&L.pvp!=='safe'){const pl=PLAYERS[Math.floor(Math.random()*PLAYERS.length)];S.event={type:'player',data:pl};let btns=`<button class="btn btn-s btn-sm" onclick="wave()">üëã</button>`;btns+=L.pvp==='open'?`<button class="btn btn-d btn-sm" onclick="attackPlayer()">‚öîÔ∏è</button>`:`<button class="btn btn-s btn-sm" onclick="duel()">–î—É—ç–ª—å</button>`;c.innerHTML=`<div class="event-icon player">üë§</div><div class="event-title">${pl.name}</div><div class="event-acts">${btns}</div>`}
else c.innerHTML=`<div class="event-icon">üåø</div><div class="event-title">–ü—É—Å—Ç–æ</div>`}
function renderGather(){const e=S.event;if(!e||e.type!=='res')return;const rt=e.rt,tool=RES_TOOL[rt],hasTool=S.p.inv.includes(tool)||S.p.eq.tool===tool;const c=$('eventCard');
c.innerHTML=`<div class="event-icon res">${RES_ICON[rt]}</div><div class="event-title">${rt} (${e.left}/4)</div>
${hasTool?`<button class="btn btn-p gather-btn" id="gatherBtn" onmousedown="startGather()" onmouseup="stopGather()" onmouseleave="stopGather()" ontouchstart="startGather()" ontouchend="stopGather()">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ: ${ITEMS[tool].icon}</button><div class="gather-prog"><div class="gather-prog-fill" id="gatherProg"></div></div>`:`<p style="color:var(--bad);margin:8px">–ù—É–∂–µ–Ω: ${ITEMS[tool].icon} ${ITEMS[tool].name}</p>`}
${e.left<4?`<p style="color:var(--ok);margin-top:8px">–°–æ–±—Ä–∞–Ω–æ: ${4-e.left}</p>`:''}`}
function startGather(){if(gatherInterval||!S.event)return;gatherProgress=0;gatherInterval=setInterval(()=>{gatherProgress+=50;$('gatherProg').style.width=(100-gatherProgress/1000*100)+'%';if(gatherProgress>=1000){gatherProgress=0;S.p.res[S.event.rt]++;S.event.left--;if(S.event.left<=0){stopGather();$('eventCard').innerHTML=`<div class="event-icon res">${RES_ICON[S.event.rt]}</div><div class="event-title">–°–æ–±—Ä–∞–Ω–æ!</div><p style="color:var(--ok)">+4 ${S.event.rt}</p>`;S.event=null}else renderGather()}},50)}
function stopGather(){if(gatherInterval){clearInterval(gatherInterval);gatherInterval=null;gatherProgress=0;const pg=$('gatherProg');if(pg)pg.style.width='100%'}}
function wave(){$('eventCard').innerHTML+='<p style="color:var(--dim);margin-top:8px">üëã</p>'}
function duel(){$('eventCard').innerHTML=`<p style="color:var(--dim)">–û–∂–∏–¥–∞–Ω–∏–µ...</p>`;setTimeout(()=>{Math.random()>.5?attackPlayer():($('eventCard').innerHTML=`<p style="color:var(--bad)">–û—Ç–∫–∞–∑</p>`)},1000)}
function attackPlayer(){if(!S.event?.data)return;const pl=S.event.data;S.combat={...pl,hp:pl.hp,maxHp:pl.hp,isPvP:1};startCombatUI()}
function startCombat(){if(!S.event?.data)return;const e=S.event.data;S.combat={...e,hp:e.hp,maxHp:e.hp};startCombatUI()}
function startCombatUI(){$('eventCard').style.display='none';$('combatCard').style.display='block';$('cEnemyAva').textContent=S.combat.icon||'üë§';$('cEnemyName').textContent=S.combat.name;S.turn='player';updCombat();renderAbils();$('combatLog').innerHTML='';$('turnInd').textContent='–í–∞—à —Ö–æ–¥'}
function updCombat(){const c=S.combat;$('cEnemyHp').style.width=(c.hp/c.maxHp*100)+'%';$('cEnemyHpTxt').textContent=`${Math.max(0,c.hp)}/${c.maxHp}`;$('cPlayerHp').style.width=(S.p.hp/S.p.maxHp*100)+'%';$('cPlayerHpTxt').textContent=`${S.p.hp}/${S.p.maxHp}`;updHdr()}
function renderAbils(){const eq=S.p.eq;let abs=[];if(eq.mainHand&&ITEMS[eq.mainHand])ITEMS[eq.mainHand].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));else abs.push({key:'punch',...ABILS.punch});if(eq.offHand&&ITEMS[eq.offHand])ITEMS[eq.offHand].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));if(eq.chest&&ITEMS[eq.chest])ITEMS[eq.chest].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));if(eq.boots&&ITEMS[eq.boots])ITEMS[eq.boots].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));while(abs.length<4)abs.push({key:'wait',...ABILS.wait});abs=abs.slice(0,4);$('abilGrid').innerHTML=abs.map(a=>`<button class="abil-btn" onclick="useAbil('${a.key}')" ${S.turn!=='player'?'disabled':''}><div class="abil-name">${a.icon} ${a.name}</div><div class="abil-desc">${a.desc}</div></button>`).join('')}
function useAbil(k){if(S.turn!=='player'||!S.combat)return;const a=ABILS[k],c=S.combat,log=$('combatLog');S.turn='wait';$('turnInd').textContent='...';renderAbils();
setTimeout(()=>{if(a.dmg){c.hp-=a.dmg;log.innerHTML+=`<div class="log-dmg">‚Üí${a.name}: ${a.dmg}</div>`}if(a.heal){S.p.hp=Math.min(S.p.maxHp,S.p.hp+a.heal);log.innerHTML+=`<div class="log-heal">‚Üí${a.name}: +${a.heal}</div>`}updCombat();if(c.hp<=0){endCombat(1);return}
S.turn='enemy';$('turnInd').textContent='–•–æ–¥ –≤—Ä–∞–≥–∞...';setTimeout(()=>{let dmg=a.evade?0:Math.max(0,c.dmg-(a.def||0));if(dmg>0){S.p.hp-=dmg;log.innerHTML+=`<div class="log-dmg">‚Üê${c.name}: ${dmg}</div>`}else if(a.evade)log.innerHTML+=`<div>–£–∫–ª–æ–Ω–µ–Ω–∏–µ!</div>`;updCombat();if(S.p.hp<=0){endCombat(0);return}S.turn='player';$('turnInd').textContent='–í–∞—à —Ö–æ–¥';renderAbils();log.scrollTop=log.scrollHeight},500)},500)}
function endCombat(win){const c=S.combat,isPvP=c.isPvP,L=LOCS[S.loc];$('combatCard').style.display='none';$('eventCard').style.display='block';
if(win){let loot='';const hasKnife=S.p.inv.includes('skinning_knife')||S.p.eq.tool==='skinning_knife';c.loot?.forEach(l=>{if(ITEMS[l]){S.p.inv.push(l);loot+=`<div>üéÅ${ITEMS[l].name}</div>`}else if(l==='leather'){if(hasKnife){S.p.res.leather++;loot+=`<div>${RES_ICON.leather}+1</div>`}else loot+=`<div style="color:var(--muted)">–ù—É–∂–µ–Ω –Ω–æ–∂ –¥–ª—è –∫–æ–∂–∏</div>`}else{S.p.res[l]++;loot+=`<div>${RES_ICON[l]}+1</div>`}});const gold=Math.floor(Math.random()*15)+5;S.p.gold+=gold;$('eventCard').innerHTML=`<div class="event-icon res">üéâ</div><div class="event-title">–ü–æ–±–µ–¥–∞!</div><div style="color:var(--ok);margin:8px">${loot}<div style="color:var(--accent)">üí∞+${gold}</div></div>`}
else{if(isPvP&&L.pvp==='open'){S.p.eq={mainHand:null,offHand:null,chest:null,boots:null,tool:null};S.p.inv=[];S.p.res={wood:0,metal:0,cloth:0,leather:0};$('eventCard').innerHTML=`<div class="event-icon enemy">üíÄ</div><div class="event-title">PvP —Å–º–µ—Ä—Ç—å!</div><p style="color:var(--bad)">–í—Å—ë –ø–æ—Ç–µ—Ä—è–Ω–æ!</p>`}else $('eventCard').innerHTML=`<div class="event-icon enemy">üíÄ</div><div class="event-title">–°–º–µ—Ä—Ç—å</div>`;S.p.hp=Math.floor(S.p.maxHp*.5);goTo('city')}
S.combat=null;updHdr()}
function renderInv(){$('resBar').innerHTML=Object.entries(S.p.res).map(([k,v])=>`<div class="res-item">${RES_ICON[k]}${v}</div>`).join('');
const slots=['mainHand','offHand','chest','boots','tool'];$('eqPanel').innerHTML=slots.map(s=>{const ik=S.p.eq[s],it=ik?ITEMS[ik]:null,icons={mainHand:'‚öîÔ∏è',offHand:'üõ°Ô∏è',chest:'üëï',boots:'üë¢',tool:'üîß'};return`<div class="eq-slot${it?' filled':''}" title="${s}">${it?it.icon:icons[s]}</div>`}).join('');
let h='';for(let i=0;i<20;i++){if(S.p.inv[i]){const it=ITEMS[S.p.inv[i]],eq=Object.values(S.p.eq).includes(S.p.inv[i]);h+=`<div class="inv-slot${eq?' eq':''}" onclick="itemMod('${S.p.inv[i]}',${i})">${eq?'<div class="eq-dot"></div>':''}${it.icon}<div class="name">${it.name}</div></div>`}else h+=`<div class="inv-slot empty"></div>`}$('invGrid').innerHTML=h}
function itemMod(ik,idx){const it=ITEMS[ik],eq=Object.values(S.p.eq).includes(ik);$('modTitle').textContent=it.icon+' '+it.name;$('modContent').innerHTML=`<p style="color:var(--dim);margin-bottom:8px">${it.desc}</p>${it.ab?.length?'<div style="font-size:12px;margin-bottom:12px">'+it.ab.map(a=>`<div>${ABILS[a].icon}${ABILS[a].name}: ${ABILS[a].desc}</div>`).join('')+'</div>':''}<div style="display:flex;gap:6px">${eq?`<button class="btn btn-s" style="flex:1" onclick="unequip('${ik}');closeMod()">–°–Ω—è—Ç—å</button>`:`<button class="btn btn-p" style="flex:1" onclick="equip('${ik}');closeMod()">–ù–∞–¥–µ—Ç—å</button>`}</div>`;$('modal').classList.add('active')}
function closeMod(){$('modal').classList.remove('active')}
function equip(ik){const it=ITEMS[ik];if(it.two)S.p.eq.offHand=null;S.p.eq[it.slot]=ik;renderInv()}
function unequip(ik){const it=ITEMS[ik];S.p.eq[it.slot]=null;renderInv()}
function renderLocList(){$('locList').innerHTML=Object.entries(LOCS).map(([k,L])=>{const cur=k===S.loc,badge=L.pvp==='safe'?'badge-ok':L.pvp==='open'?'badge-bad':'badge-warn';return`<div class="loc-item${cur?' current':''}" onclick="${cur?'':`goTo('${k}')`}"><div style="font-size:20px">${L.icon}</div><div style="flex:1"><div style="font-weight:600">${L.name} <span class="badge ${badge}">${L.pvp}</span></div><div style="font-size:11px;color:var(--dim)">${L.isCity?'–ì–æ—Ä–æ–¥':'–£—Ä.'+L.tier}${cur?' ‚Ä¢ –í—ã –∑–¥–µ—Å—å':''}</div></div></div>`}).join('')}
function renderCity(){cityTab('craft')}
function cityTab(t){document.querySelectorAll('#cityTabs .tab').forEach((x,i)=>x.classList.toggle('active',t==='craft'&&!i||t==='bank'&&i===1||t==='auc'&&i===2));if(t==='craft')renderCraft();else if(t==='bank')renderBank();else renderAuc()}
function renderCraft(cat='weapons'){const cats={weapons:['wooden_sword','iron_sword','wooden_bow','wooden_staff','wooden_shield'],armor:['cloth_robe','leather_armor','plate_armor'],boots:['cloth_boots','leather_boots','plate_boots'],tools:['pickaxe','axe','sickle','skinning_knife']};let h=`<div class="tabs"><button class="tab${cat==='weapons'?' active':''}" onclick="renderCraft('weapons')">–û—Ä—É–∂–∏–µ</button><button class="tab${cat==='armor'?' active':''}" onclick="renderCraft('armor')">–ë—Ä–æ–Ω—è</button><button class="tab${cat==='boots'?' active':''}" onclick="renderCraft('boots')">–û–±—É–≤—å</button><button class="tab${cat==='tools'?' active':''}" onclick="renderCraft('tools')">–ò–Ω—Å—Ç—Ä.</button></div>`;
h+=cats[cat].map(k=>{const it=ITEMS[k],rec=RECIPES[k];if(!rec)return'';const can=Object.entries(rec).every(([r,n])=>S.p.res[r]>=n);const reqs=Object.entries(rec).map(([r,n])=>`<span class="craft-req ${S.p.res[r]>=n?'ok':'no'}">${RES_ICON[r]}${S.p.res[r]}/${n}</span>`).join('');return`<div class="craft-item"><div class="craft-icon">${it.icon}</div><div class="craft-info"><div class="craft-name">${it.name}</div><div class="craft-reqs">${reqs}</div></div><button class="btn btn-sm${can?' btn-p':' btn-s'}" onclick="craft('${k}')"${can?'':' disabled'}>+</button></div>`}).join('');$('cityContent').innerHTML=h}
function craft(k){const rec=RECIPES[k];for(const[r,n]of Object.entries(rec))if(S.p.res[r]<n)return;for(const[r,n]of Object.entries(rec))S.p.res[r]-=n;S.p.inv.push(k);renderCraft()}
function renderBank(){$('cityContent').innerHTML=`<div class="card"><div class="card-title">–ë–∞–Ω–∫</div><p style="font-size:11px;color:var(--dim);margin-bottom:8px">–ó–∞—â–∏—â–µ–Ω–æ –æ—Ç PvP —Å–º–µ—Ä—Ç–∏</p><div class="res-bar" style="margin-bottom:8px">${Object.entries(S.p.bank.res).map(([k,v])=>`<div class="res-item">${RES_ICON[k]}${v}</div>`).join('')}</div><div style="display:flex;gap:6px;margin-bottom:10px"><button class="btn btn-sm btn-s" onclick="depositRes()">üì•–†–µ—Å.</button><button class="btn btn-sm btn-s" onclick="withdrawRes()">üì§–†–µ—Å.</button></div><div class="card-title">–ü—Ä–µ–¥–º–µ—Ç—ã –≤ –±–∞–Ω–∫–µ</div><div class="bank-grid">${S.p.bank.items.map((ik,i)=>`<div class="inv-slot" onclick="withdrawItem(${i})">${ITEMS[ik].icon}<div class="name">${ITEMS[ik].name}</div></div>`).join('')||'<div style="grid-column:span 4;color:var(--muted);font-size:11px;text-align:center;padding:12px">–ü—É—Å—Ç–æ</div>'}</div></div><div class="card"><div class="card-title">–ü–æ–ª–æ–∂–∏—Ç—å</div><div class="bank-grid">${S.p.inv.filter(ik=>!Object.values(S.p.eq).includes(ik)).map((ik,i)=>`<div class="inv-slot" onclick="depositItem(${S.p.inv.indexOf(ik)})">${ITEMS[ik].icon}<div class="name">${ITEMS[ik].name}</div></div>`).join('')||'<div style="grid-column:span 4;color:var(--muted);font-size:11px;text-align:center;padding:12px">–ü—É—Å—Ç–æ</div>'}</div></div>`}
function depositRes(){for(const r in S.p.res){S.p.bank.res[r]+=S.p.res[r];S.p.res[r]=0}renderBank()}
function withdrawRes(){for(const r in S.p.bank.res){S.p.res[r]+=S.p.bank.res[r];S.p.bank.res[r]=0}renderBank()}
function depositItem(i){const ik=S.p.inv[i];S.p.inv.splice(i,1);S.p.bank.items.push(ik);renderBank()}
function withdrawItem(i){const ik=S.p.bank.items[i];S.p.bank.items.splice(i,1);S.p.inv.push(ik);renderBank()}
function renderAuc(){const grouped={};AUC.forEach(a=>{if(!grouped[a.item])grouped[a.item]={item:a.item,orders:[],minPrice:a.price};grouped[a.item].orders.push(a);if(a.price<grouped[a.item].minPrice)grouped[a.item].minPrice=a.price});
let items=Object.values(grouped).filter(g=>{const it=ITEMS[g.item];if(aucFilter!=='all'){if(aucFilter==='weapon'&&it.slot!=='mainHand'&&it.slot!=='offHand')return false;if(aucFilter==='armor'&&it.slot!=='chest')return false;if(aucFilter==='boots'&&it.slot!=='boots')return false;if(aucFilter==='tool'&&it.slot!=='tool')return false}if(aucSearch&&!it.name.toLowerCase().includes(aucSearch.toLowerCase()))return false;return true});
if(aucSort==='price')items.sort((a,b)=>a.minPrice-b.minPrice);else items.sort((a,b)=>ITEMS[a.item].name.localeCompare(ITEMS[b.item].name));
$('cityContent').innerHTML=`<div class="auc-filters"><select onchange="aucFilter=this.value;renderAuc()"><option value="all">–í—Å–µ</option><option value="weapon"${aucFilter==='weapon'?' selected':''}>–û—Ä—É–∂–∏–µ</option><option value="armor"${aucFilter==='armor'?' selected':''}>–ë—Ä–æ–Ω—è</option><option value="boots"${aucFilter==='boots'?' selected':''}>–û–±—É–≤—å</option><option value="tool"${aucFilter==='tool'?' selected':''}>–ò–Ω—Å—Ç—Ä.</option></select><select onchange="aucSort=this.value;renderAuc()"><option value="price">–¶–µ–Ω–∞‚Üë</option><option value="name"${aucSort==='name'?' selected':''}>–ò–º—è</option></select><input type="text" placeholder="–ü–æ–∏—Å–∫" value="${aucSearch}" oninput="aucSearch=this.value;renderAuc()"><label class="toggle"><input type="checkbox" ${aucExec?'checked':''} onchange="aucExec=this.checked;renderAuc()">–¢–µ—Å—Ç</label></div>
<div class="card"><div class="card-title">–ö—É–ø–∏—Ç—å</div>${items.length?items.map(g=>{const it=ITEMS[g.item];return`<div class="auc-group" id="aucg_${g.item}"><div class="auc-group-head" onclick="toggleAucGroup('${g.item}')"><div class="auc-icon">${it.icon}</div><div class="auc-group-info"><div class="auc-group-name">${it.name}</div><div class="auc-group-meta">${g.orders.length} –ª–æ—Ç–æ–≤</div></div><div class="auc-group-price">–æ—Ç üí∞${g.minPrice}</div></div><div class="auc-orders" id="auco_${g.item}">${g.orders.sort((a,b)=>a.price-b.price).map(o=>`<div class="auc-order"><div class="auc-order-info">${o.seller}</div><div class="auc-order-price">üí∞${o.price}</div>${aucExec?`<button class="btn btn-sm btn-s" onclick="execOrder(${o.id})">–ò—Å–ø–æ–ª–Ω.</button>`:`<button class="btn btn-sm${S.p.gold>=o.price?' btn-p':' btn-s'}" onclick="buyAuc(${o.id})"${S.p.gold>=o.price?'':' disabled'}>–ö—É–ø–∏—Ç—å</button>`}</div>`).join('')}</div></div>`}).join(''):'<p style="color:var(--muted);font-size:11px;text-align:center;padding:12px">–ù–µ—Ç –ª–æ—Ç–æ–≤</p>'}</div>
<div class="card"><div class="card-title">–ü—Ä–æ–¥–∞—Ç—å</div>${S.p.inv.filter(ik=>!Object.values(S.p.eq).includes(ik)).map(ik=>`<div class="craft-item"><div class="craft-icon">${ITEMS[ik].icon}</div><div class="craft-info"><div class="craft-name">${ITEMS[ik].name}</div></div><button class="btn btn-sm btn-s" onclick="showSell('${ik}')">–ü—Ä–æ–¥–∞—Ç—å</button></div>`).join('')||'<p style="color:var(--muted);font-size:11px;text-align:center;padding:12px">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>'}</div>`}
function toggleAucGroup(item){$('auco_'+item).classList.toggle('open')}
function showSell(ik){$('modTitle').textContent='–ü—Ä–æ–¥–∞—Ç—å '+ITEMS[ik].name;$('modContent').innerHTML=`<input type="number" id="sellPrice" placeholder="–¶–µ–Ω–∞" min="1" value="50" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:8px"><button class="btn btn-p" style="width:100%" onclick="sellAuc('${ik}')">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>`;$('modal').classList.add('active')}
function sellAuc(ik){const price=parseInt($('sellPrice').value)||50,idx=S.p.inv.indexOf(ik);if(idx===-1)return;S.p.inv.splice(idx,1);AUC.push({id:aucId++,item:ik,price,seller:'–í—ã'});closeMod();renderAuc()}
function buyAuc(id){const idx=AUC.findIndex(a=>a.id===id);if(idx===-1)return;const a=AUC[idx];if(S.p.gold<a.price)return;S.p.gold-=a.price;S.p.inv.push(a.item);AUC.splice(idx,1);updHdr();renderAuc()}
function execOrder(id){const idx=AUC.findIndex(a=>a.id===id);if(idx===-1)return;const a=AUC[idx];S.p.gold+=a.price;AUC.splice(idx,1);updHdr();renderAuc();$('modTitle').textContent='–û—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω';$('modContent').innerHTML=`<p>–ò–≥—Ä–æ–∫ –∫—É–ø–∏–ª –≤–∞—à ${ITEMS[a.item].name} –∑–∞ üí∞${a.price}</p>`;$('modal').classList.add('active')}
function renderMast(){$('mastList').innerHTML=Object.entries(S.p.mast).map(([k,m])=>{const need=m.lv*100,pct=Math.min(100,m.xp/need*100),icons={sword:'‚öîÔ∏è',bow:'üèπ',staff:'ü™Ñ',cloth:'üëò',leather:'ü¶∫',plate:'üõ°Ô∏è'};return`<div class="mast-item"><div class="mast-icon">${icons[k]}</div><div class="mast-info"><div class="mast-head"><span>${k}</span><span class="mast-lv">–£—Ä.${m.lv}</span></div><div class="mast-bar"><div class="mast-bar-fill" style="width:${pct}%"></div></div></div></div>`}).join('')}
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ DOMContentLoaded –≤—ã—à–µ
</script>
</body>
</html>