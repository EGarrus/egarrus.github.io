<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MMORPG Reforged</title>
<style>
/* CSS STYLES */
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1d23;--card:#23272f;--border:#363b44;--text:#e8e6e3;--dim:#9a9fa8;--muted:#5c6370;--accent:#c9a227;--hp:#c94a4a;--xp:#8b5cf6;--ok:#4ade80;--bad:#ef4444;--warn:#f59e0b}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none}
.hdr{background:var(--card);padding:10px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.avatar{width:40px;height:40px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid var(--accent)}
.hdr-info{flex:1}.hdr-name{font-weight:600;font-size:14px}
.bar{height:6px;background:#3d2a2a;border-radius:3px;margin-top:4px}.bar-fill{height:100%;border-radius:3px;transition:width .3s}.bar-hp{background:var(--hp)}
.gold{display:flex;align-items:center;gap:4px;color:var(--accent);font-weight:600}
.main{flex:1;overflow-y:auto;padding:12px;padding-bottom:70px}
.screen{display:none}.screen.active{display:block}
.card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border);position:relative}
.card-title{font-size:12px;font-weight:600;color:var(--dim);text-transform:uppercase;margin-bottom:10px}
.card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.btn{padding:10px 14px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;width:100%}
.btn-p{background:var(--accent);color:#000}.btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-d{background:var(--bad);color:#fff}.btn-w{background:var(--warn);color:#000}
.btn:disabled{opacity:.4;cursor:not-allowed}.btn-sm{padding:6px 10px;font-size:12px;width:auto}
.tabs{display:flex;gap:4px;margin-bottom:12px;background:var(--bg);padding:4px;border-radius:8px}
.tab{flex:1;padding:8px;background:none;border:none;border-radius:6px;color:var(--dim);font-size:12px;cursor:pointer}.tab.active{background:var(--card);color:var(--text)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-ok{background:rgba(74,222,128,.2);color:var(--ok)}.badge-warn{background:rgba(245,158,11,.2);color:var(--warn)}.badge-bad{background:rgba(239,68,68,.2);color:var(--bad)}
.chunk-bar{display:flex;gap:2px;margin:10px 0}.chunk-dot{flex:1;height:6px;background:var(--bg);border-radius:3px}.chunk-dot.done{background:var(--accent)}.chunk-dot.current{background:var(--ok)}
.chunk-desc{font-size:12px;color:var(--dim);font-style:italic;margin:10px 0;text-align:center}
.step-btn{position:relative;overflow:hidden;padding:14px}.step-prog{position:absolute;left:0;top:0;height:100%;background:rgba(255,255,255,.2);width:0;transition:width .05s linear}
.step-time{font-size:11px;color:var(--dim);text-align:center;margin-top:6px}
.travel-bar{background:var(--bg);border-radius:6px;padding:10px;margin-bottom:10px}
.travel-prog{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin:6px 0}.travel-prog-fill{height:100%;background:var(--accent);transition:width .1s linear}
.map-btn{width:32px;height:32px;border-radius:8px;font-size:16px;margin-left:auto}
.event{text-align:center;padding:16px}
.event-icon{width:64px;height:64px;margin:0 auto 12px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;border:2px solid var(--border)}
.event-icon.enemy{border-color:var(--bad)}.event-icon.res{border-color:var(--ok)}.event-icon.player{border-color:var(--xp)}
.event-title{font-size:16px;font-weight:700;margin-bottom:6px}
.event-stats{display:flex;justify-content:center;gap:12px;font-size:13px;color:var(--dim);margin:8px 0}
.event-acts{display:flex;gap:6px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.gather-prog{height:4px;background:var(--bg);border-radius:2px;margin-top:8px;overflow:hidden}.gather-prog-fill{height:100%;background:var(--ok);width:100%;transition:width .05s linear}
.combat{background:linear-gradient(180deg,#2a1f1f,var(--card));border-color:var(--bad)}
.fighter{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px}
.fighter-ava{width:44px;height:44px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px}
.fighter-info{flex:1}.fighter-name{font-weight:600;font-size:13px;margin-bottom:4px}
.fighter-hp{height:10px;background:#3d2a2a;border-radius:5px;overflow:hidden;position:relative}.fighter-hp-fill{height:100%;background:linear-gradient(90deg,#b91c1c,var(--hp));transition:width .3s}.fighter-hp-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;font-weight:700}
.abilities{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px}
.abil-btn{padding:10px 8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left}.abil-btn:hover{border-color:var(--accent)}.abil-btn:disabled{opacity:.5}
.abil-name{font-weight:600;font-size:12px}.abil-desc{font-size:10px;color:var(--muted)}
.turn-ind{text-align:center;padding:6px;font-size:11px;color:var(--accent)}
.log{max-height:80px;overflow-y:auto;background:var(--bg);border-radius:6px;padding:8px;margin-top:10px;font-size:11px}.log-dmg{color:var(--bad)}.log-heal{color:var(--ok)}
.weight-bar{height:12px;background:var(--bg);border-radius:6px;overflow:hidden;position:relative;margin:8px 0}
.weight-bar-fill{height:100%;transition:width .3s}
.weight-bar-marks{position:absolute;top:0;left:0;right:0;bottom:0;display:flex}
.weight-mark{height:100%;border-right:2px solid var(--card)}
.weight-info{display:flex;justify-content:space-between;font-size:11px;color:var(--dim)}
.weight-status{font-weight:600}.weight-status.normal{color:var(--ok)}.weight-status.medium{color:var(--warn)}.weight-status.heavy{color:var(--bad)}.weight-status.over{color:#f00}
.inv-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.inv-slot{aspect-ratio:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;font-size:20px;position:relative}
.inv-slot:hover{border-color:var(--accent)}.inv-slot.empty{opacity:.3;cursor:default}
.inv-slot.eq{border-color:var(--accent);background:rgba(201,162,39,.1)}
.inv-slot .qty{position:absolute;bottom:2px;right:4px;font-size:10px;font-weight:600}
.inv-slot .name{font-size:8px;color:var(--dim);text-align:center;margin-top:2px}
.eq-panel{display:flex;justify-content:center;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.eq-slot{width:44px;height:44px;background:var(--bg);border:1px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--muted);position:relative;cursor:pointer}
.eq-slot.filled{border-style:solid;border-color:var(--accent);color:var(--text)}
.eq-slot .eq-label{position:absolute;bottom:-14px;font-size:8px;color:var(--muted);white-space:nowrap}
.loc-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;cursor:pointer}
.loc-item:hover{border-color:var(--accent)}.loc-item.current{border-color:var(--ok)}.loc-item.locked{opacity:.5;cursor:not-allowed}
.craft-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:10px;margin-bottom:6px}
.craft-icon{width:40px;height:40px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.craft-info{flex:1}.craft-name{font-weight:600;font-size:13px}
.craft-reqs{display:flex;gap:6px;font-size:11px;margin-top:2px;flex-wrap:wrap}
.craft-req{padding:2px 5px;background:var(--card);border-radius:3px}.craft-req.ok{color:var(--ok)}.craft-req.no{color:var(--bad)}
.mast-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px}
.mast-icon{width:36px;height:36px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px}
.mast-info{flex:1}.mast-head{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}.mast-lv{color:var(--xp);font-weight:600}
.mast-bar{height:4px;background:var(--bg);border-radius:2px}.mast-bar-fill{height:100%;background:var(--xp);border-radius:2px}
.auc-filters{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.auc-filters select,.auc-filters input{padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}
.auc-filters input[type=text]{flex:1;min-width:60px}
.toggle{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--dim)}
.toggle input{width:32px;height:18px;appearance:none;background:var(--bg);border-radius:9px;position:relative;cursor:pointer}
.toggle input::after{content:'';position:absolute;width:14px;height:14px;background:var(--dim);border-radius:50%;top:2px;left:2px;transition:.2s}
.toggle input:checked{background:var(--accent)}.toggle input:checked::after{left:16px;background:#fff}
.auc-group{background:var(--bg);border-radius:8px;margin-bottom:6px;overflow:hidden}
.auc-group-head{display:flex;align-items:center;gap:8px;padding:10px;cursor:pointer}
.auc-icon{width:32px;height:32px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px}
.auc-group-info{flex:1}.auc-group-name{font-weight:600;font-size:13px}.auc-group-meta{font-size:10px;color:var(--muted)}
.auc-group-price{color:var(--accent);font-weight:600;font-size:12px}
.auc-orders{padding:0 10px 10px;display:none}.auc-orders.open{display:block}
.auc-order{display:flex;align-items:center;gap:8px;padding:6px;background:var(--card);border-radius:6px;margin-bottom:4px;font-size:12px}
.auc-order-info{flex:1}.auc-order-price{color:var(--accent)}
.bank-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.qty-input{display:flex;align-items:center;gap:8px;margin:12px 0}
.qty-input input{flex:1;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);text-align:center}
.qty-btns{display:flex;gap:4px}
.qty-btns button{width:32px;height:32px;border:none;border-radius:6px;background:var(--bg);color:var(--text);cursor:pointer;font-weight:600}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal.active{display:flex}
.modal-box{background:var(--card);border-radius:12px;padding:16px;width:100%;max-width:320px;max-height:80vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.modal-title{font-size:16px;font-weight:700}.modal-close{width:28px;height:28px;background:var(--bg);border:none;border-radius:6px;color:var(--dim);cursor:pointer;font-size:16px}
.nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:var(--card);border-top:1px solid var(--border);display:flex;padding:6px}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 6px;background:none;border:none;color:var(--muted);cursor:pointer;border-radius:8px;font-size:10px}
.nav-item.active{color:var(--accent);background:var(--bg)}
.nav-item.center{background:var(--accent);color:#000;border-radius:10px}
.end-loc{display:flex;gap:6px;margin-top:10px}
</style>
</head>
<body>
<div class="hdr">
<div class="avatar">üë§</div>
<div class="hdr-info"><div class="hdr-name">–ò–≥—Ä–æ–∫</div><div class="bar"><div class="bar-fill bar-hp" id="hdrHp" style="width:100%"></div></div></div>
<div class="gold">üí∞<span id="hdrGold">150</span></div>
</div>
<div class="main">
<div id="travelBar" class="travel-bar" style="display:none">
<div class="card-head" style="margin:0"><h4 id="travelText">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ...</h4><span id="travelTime" style="font-size:11px;color:var(--dim)"></span></div>
<div class="travel-prog"><div class="travel-prog-fill" id="travelProg"></div></div>
</div>
<!-- CITY SCREEN -->
<div class="screen" id="sCity">
<div class="card">
<div class="card-head"><div class="card-title">üè∞ –ì–æ—Ä–æ–¥</div><button class="btn btn-s map-btn" onclick="openMap()">üó∫Ô∏è</button></div>
<div class="tabs" id="cityTabs">
<button class="tab active" onclick="cityTab('craft')">–ö—Ä–∞—Ñ—Ç</button>
<button class="tab" onclick="cityTab('bank')">–ë–∞–Ω–∫</button>
<button class="tab" onclick="cityTab('auc')">–ê—É–∫—Ü–∏–æ–Ω</button>
</div>
<div id="cityContent"></div>
<button class="btn btn-p" style="margin-top:12px" onclick="leaveCity()">üö∂ –í –ø—É—Ç—å</button>
</div>
</div>
<!-- WORLD SCREEN -->
<div class="screen" id="sWorld">
<div class="card">
<div class="card-head">
<div><span style="font-weight:700" id="wLocName"></span> <span class="badge" id="wLocPvp"></span></div>
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;color:var(--dim)" id="wLocTier"></span>
<button class="btn btn-s map-btn" onclick="openMap()">üó∫Ô∏è</button>
</div>
</div>
<div class="chunk-bar" id="chunkBar"></div>
<div class="chunk-desc" id="chunkDesc"></div>
<div id="stepArea"></div>
<div id="endLocArea" style="display:none"></div>
</div>
<div class="card event" id="eventCard"></div>
<div class="card combat" id="combatCard" style="display:none">
<div class="fighter"><div class="fighter-ava" id="cEnemyAva"></div><div class="fighter-info"><div class="fighter-name" id="cEnemyName"></div><div class="fighter-hp"><div class="fighter-hp-fill" id="cEnemyHp"></div><span class="fighter-hp-text" id="cEnemyHpTxt"></span></div></div></div>
<div class="turn-ind" id="turnInd"></div>
<div class="fighter"><div class="fighter-ava">üë§</div><div class="fighter-info"><div class="fighter-name">–í—ã</div><div class="fighter-hp"><div class="fighter-hp-fill" id="cPlayerHp"></div><span class="fighter-hp-text" id="cPlayerHpTxt"></span></div></div></div>
<div class="abilities" id="abilGrid"></div>
<div class="log" id="combatLog"></div>
</div>
</div>
<!-- MAP SCREEN -->
<div class="screen" id="sMap"><div class="card"><div class="card-title">–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</div><div id="locList"></div></div></div>
<!-- INV SCREEN -->
<div class="screen" id="sInv">
<div class="card"><div class="card-title">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div><div class="eq-panel" id="eqPanel"></div></div>
<div class="card"><div class="card-title">–°—É–º–∫–∞</div>
<div class="weight-bar"><div class="weight-bar-fill" id="weightFill"></div><div class="weight-bar-marks" id="weightMarks"></div></div>
<div class="weight-info"><span id="weightText"></span><span class="weight-status" id="weightStatus"></span></div>
<div class="inv-grid" id="invGrid"></div></div>
</div>
<!-- MAST SCREEN -->
<div class="screen" id="sMast"><div class="card"><div class="card-title">–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</div><div id="mastList"></div></div></div>
</div>
<div class="nav">
<button class="nav-item" onclick="nav('Inv')">üéí<span>–°—É–º–∫–∞</span></button>
<button class="nav-item center" id="navCenter" onclick="nav('Center')">üè∞<span>–ì–æ—Ä–æ–¥</span></button>
<button class="nav-item" onclick="nav('Mast')">üìä<span>–°–∫–∏–ª—ã</span></button>
</div>
<div class="modal" id="modal"><div class="modal-box"><div class="modal-head"><div class="modal-title" id="modTitle"></div><button class="modal-close" onclick="closeMod()">√ó</button></div><div id="modContent"></div></div></div>
<script>
// CONFIG
const CFG={stepTimes:{normal:1000,medium:4000,heavy:10000},cityTeleport:3000,
chunkDescs:['–¢—Ä–æ–ø–∞ –ø–µ—Ç–ª—è–µ—Ç –º–µ–∂–¥—É —Ö–æ–ª–º–∞–º–∏...','–í–¥–∞–ª–∏ —Å–ª—ã—à–µ–Ω —à—É–º —Ä—É—á—å—è...','–ü–æ–¥ –Ω–æ–≥–∞–º–∏ —Ö—Ä—É—Å—Ç–∏—Ç –≥—Ä–∞–≤–∏–π...','–°–æ–ª–Ω—Ü–µ –ø—Ä–æ–±–∏–≤–∞–µ—Ç—Å—è —Å–∫–≤–æ–∑—å –∫—Ä–æ–Ω—ã...','–í–æ–∑–¥—É—Ö –ø–∞—Ö–Ω–µ—Ç —Å—ã—Ä–æ—Å—Ç—å—é...','–ü—Ç–∏—Ü—ã –∑–∞–º–æ–ª–∫–ª–∏...','–ß—Ç–æ-—Ç–æ —à—É—Ä—à–∏—Ç –≤ –∫—É—Å—Ç–∞—Ö...']};

const ITEMS={
wood:{name:'–î–µ—Ä–µ–≤–æ',icon:'ü™µ',weight:1,stack:20,type:'res'},metal:{name:'–†—É–¥–∞',icon:'üß±',weight:2,stack:15,type:'res'},
cloth:{name:'–¢–∫–∞–Ω—å',icon:'üß∂',weight:.5,stack:30,type:'res'},leather:{name:'–ö–æ–∂–∞',icon:'ü¶¥',weight:1,stack:20,type:'res'},
pickaxe:{name:'–ö–∏—Ä–∫–∞',icon:'‚õèÔ∏è',weight:3,stack:1,type:'tool',gathers:'metal',desc:'–î–æ–±—ã—á–∞ —Ä—É–¥—ã'},
axe:{name:'–¢–æ–ø–æ—Ä',icon:'ü™ì',weight:3,stack:1,type:'tool',gathers:'wood',desc:'–†—É–±–∫–∞ –¥–µ—Ä–µ–≤–∞'},
sickle:{name:'–°–µ—Ä–ø',icon:'üåæ',weight:2,stack:1,type:'tool',gathers:'cloth',desc:'–°–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π'},
skinning_knife:{name:'–ù–æ–∂',icon:'üî™',weight:1,stack:1,type:'tool',gathers:'leather',desc:'–°–Ω—è—Ç–∏–µ —à–∫—É—Ä'},
wooden_sword:{name:'–î–µ—Ä–µ–≤.–º–µ—á',icon:'üó°Ô∏è',weight:2,stack:1,slot:'mainHand',ab:['slash','block'],cat:'sword',desc:'–°–ª–∞–±—ã–π –º–µ—á',dmg:5},
iron_sword:{name:'–ñ–µ–ª.–º–µ—á',icon:'‚öîÔ∏è',weight:3,stack:1,slot:'mainHand',ab:['slash','parry'],cat:'sword',desc:'–û—Å—Ç—Ä—ã–π –º–µ—á',dmg:10},
wooden_bow:{name:'–õ—É–∫',icon:'üèπ',weight:2,stack:1,slot:'mainHand',ab:['shoot','multishot'],cat:'bow',two:1,desc:'–î–ª—è –æ—Ö–æ—Ç—ã',dmg:8},
wooden_staff:{name:'–ü–æ—Å–æ—Ö',icon:'ü™Ñ',weight:2,stack:1,slot:'mainHand',ab:['fireball','heal'],cat:'staff',two:1,desc:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π',dmg:12},
wooden_shield:{name:'–©–∏—Ç',icon:'üõ°Ô∏è',weight:4,stack:1,slot:'offHand',ab:['shieldblock'],cat:'shield',desc:'–ó–∞—â–∏—Ç–∞',def:5},
cloth_robe:{name:'–†–æ–±–∞',icon:'üëò',weight:2,stack:1,slot:'chest',ab:['mana_shield'],cat:'cloth',desc:'–õ–µ–≥–∫–∞—è',def:2},
leather_armor:{name:'–ö–æ–∂.–±—Ä–æ–Ω—è',icon:'ü¶∫',weight:5,stack:1,slot:'chest',ab:['dodge'],cat:'leather',desc:'–°—Ä–µ–¥–Ω—è—è',def:5},
plate_armor:{name:'–õ–∞—Ç—ã',icon:'üõ°Ô∏è',weight:10,stack:1,slot:'chest',ab:['fortify'],cat:'plate',desc:'–¢—è–∂–µ–ª–∞—è',def:10},
cloth_boots:{name:'–¢–∫.—Å–∞–ø–æ–≥–∏',icon:'üëü',weight:1,stack:1,slot:'boots',ab:['blink'],cat:'cloth',desc:'–ë—ã—Å—Ç—Ä—ã–µ',def:1},
leather_boots:{name:'–ö–æ–∂.—Å–∞–ø–æ–≥–∏',icon:'ü•æ',weight:2,stack:1,slot:'boots',ab:['dash'],cat:'leather',desc:'–ü—Ä–æ—á–Ω—ã–µ',def:2},
plate_boots:{name:'–õ–∞—Ç.—Å–∞–ø–æ–≥–∏',icon:'ü¶∂',weight:5,stack:1,slot:'boots',ab:['stomp'],cat:'plate',desc:'–ñ–µ–ª–µ–∑–Ω—ã–µ',def:4},
basic_bag:{name:'–ü—Ä–æ—Å—Ç–∞—è —Å—É–º–∫–∞',icon:'üéí',weight:1,stack:1,slot:'bag',slots:12,wNorm:15,wMed:25,wHeavy:35,wMax:45,desc:'12 —Å–ª–æ—Ç–æ–≤'},
large_bag:{name:'–ë–æ–ª—å—à–∞—è —Å—É–º–∫–∞',icon:'üéí',weight:2,stack:1,slot:'bag',slots:16,wNorm:20,wMed:35,wHeavy:50,wMax:60,desc:'16 —Å–ª–æ—Ç–æ–≤'},
basic_cloak:{name:'–ü–ª–∞—â',icon:'üß•',weight:1,stack:1,slot:'cloak',ab:[],desc:'–û—Ç –≤–µ—Ç—Ä–∞'}
};
const ABILS={punch:{name:'–£–¥–∞—Ä',icon:'üëä',dmg:5,desc:'5'},wait:{name:'–ñ–¥–∞—Ç—å',icon:'‚è≥',heal:5,desc:'+5'},
slash:{name:'–†—É–±—è—â–∏–π',icon:'‚öîÔ∏è',dmg:15,desc:'15'},block:{name:'–ë–ª–æ–∫',icon:'üõ°Ô∏è',def:20,desc:'üõ°20'},
parry:{name:'–ü–∞—Ä–∏—Ä.',icon:'‚Ü©Ô∏è',dmg:10,def:10,desc:'10/10'},shoot:{name:'–í—ã—Å—Ç—Ä–µ–ª',icon:'üèπ',dmg:18,desc:'18'},
multishot:{name:'–ó–∞–ª–ø',icon:'üéØ',dmg:24,desc:'24'},fireball:{name:'–û–≥–Ω–µ—à–∞—Ä',icon:'üî•',dmg:25,desc:'25'},
heal:{name:'–õ–µ—á–µ–Ω–∏–µ',icon:'üíö',heal:30,desc:'+30'},shieldblock:{name:'–ë–ª–æ–∫',icon:'üõ°Ô∏è',def:25,desc:'üõ°25'},
mana_shield:{name:'–ú–∞–Ω–∞-—â–∏—Ç',icon:'üîÆ',def:25,desc:'üõ°25'},dodge:{name:'–£–∫–ª–æ–Ω',icon:'üí®',evade:1,desc:'–£–∫–ª–æ–Ω'},
fortify:{name:'–£–∫—Ä–µ–ø–ª.',icon:'üè∞',def:30,desc:'üõ°30'},blink:{name:'–¢–µ–ª–µ–ø–æ—Ä—Ç',icon:'‚ú®',dmg:15,evade:1,desc:'15+–£'},
dash:{name:'–†—ã–≤–æ–∫',icon:'üí®',dmg:12,desc:'12'},stomp:{name:'–¢–æ–ø–æ—Ç',icon:'üí•',dmg:20,desc:'20'}};
const RECIPES={wooden_sword:{wood:2,metal:1},iron_sword:{metal:4,wood:1},wooden_bow:{wood:3},wooden_staff:{wood:2,cloth:1},
wooden_shield:{wood:2,leather:1},cloth_robe:{cloth:4},leather_armor:{leather:4},plate_armor:{metal:4,leather:2},
cloth_boots:{cloth:2},leather_boots:{leather:2},plate_boots:{metal:2,leather:1},
pickaxe:{wood:1,metal:2},axe:{wood:1,metal:2},sickle:{wood:1,metal:1},skinning_knife:{wood:1,metal:1},
basic_bag:{leather:3,cloth:2},large_bag:{leather:6,cloth:4},basic_cloak:{cloth:3}};
const LOC_ORDER=['city','meadow','forest','highlands','swamp'];
const LOCS={city:{name:'–ì–æ—Ä–æ–¥',icon:'üè∞',chunks:1,tier:0,pvp:'safe',isCity:true},
meadow:{name:'–õ—É–≥–∞',icon:'üåø',chunks:10,tier:1,pvp:'request',enemies:['slime','wolf'],res:['wood','cloth'],next:'forest'},
forest:{name:'–õ–µ—Å',icon:'üå≤',chunks:12,tier:2,pvp:'request',enemies:['wolf','bear'],res:['wood','leather'],next:'highlands'},
highlands:{name:'–í—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ',icon:'‚õ∞Ô∏è',chunks:15,tier:3,pvp:'open',enemies:['golem','harpy'],res:['metal','leather'],next:'swamp'},
swamp:{name:'–ë–æ–ª–æ—Ç–∞',icon:'üêä',chunks:10,tier:2,pvp:'open',enemies:['lizard','witch'],res:['cloth','leather']}};
const ENEMIES={slime:{name:'–°–ª–∏–∑–µ–Ω—å',icon:'üü¢',hp:30,dmg:5,loot:[]},wolf:{name:'–í–æ–ª–∫',icon:'üê∫',hp:50,dmg:10,loot:['leather']},
bear:{name:'–ú–µ–¥–≤–µ–¥—å',icon:'üêª',hp:80,dmg:15,loot:['leather','leather']},golem:{name:'–ì–æ–ª–µ–º',icon:'üóø',hp:120,dmg:18,loot:['metal','metal']},
harpy:{name:'–ì–∞—Ä–ø–∏—è',icon:'ü¶Ö',hp:60,dmg:20,loot:[]},lizard:{name:'–Ø—â–µ—Ä',icon:'ü¶é',hp:70,dmg:14,loot:['leather']},
witch:{name:'–í–µ–¥—å–º–∞',icon:'üßô‚Äç‚ôÄÔ∏è',hp:45,dmg:25,loot:[]}};
const PLAYERS=[{name:'–†—ã—Ü–∞—Ä—å_42',hp:80,dmg:15,loot:['iron_sword']},{name:'MagicUser',hp:60,dmg:20,loot:['wooden_staff']}];

// STATE
let nextUid=1;
const G={
  p:{hp:100,maxHp:100,gold:150,inv:[],eq:{mainHand:null,offHand:null,chest:null,boots:null,bag:null,cloak:null},bank:[],mast:{sword:{lv:3,xp:45},bow:{lv:1,xp:0},staff:{lv:2,xp:80},cloth:{lv:1,xp:20},leather:{lv:2,xp:10},plate:{lv:1,xp:0}}},
  loc:'city',chunk:0,unlocked:['city','meadow'],combat:null,event:null,turn:'player',stepping:false,traveling:false
};
// Initial items list (bag must be first to avoid overflow logic during manual init)
const initList=[{id:'wooden_sword',qty:1},{id:'leather_armor',qty:1},{id:'pickaxe',qty:1},{id:'axe',qty:1},{id:'sickle',qty:1},{id:'skinning_knife',qty:1},{id:'wood',qty:5},{id:'metal',qty:3},{id:'cloth',qty:2},{id:'leather',qty:2}];

let AUC=[{id:1,item:'iron_sword',price:100,seller:'–¢–æ—Ä–≥–æ–≤–µ—Ü'},{id:2,item:'plate_armor',price:200,seller:'–ö—É–∑–Ω–µ—Ü'},{id:3,item:'wood',price:5,seller:'–õ–µ—Å–Ω–∏–∫'},{id:4,item:'metal',price:10,seller:'–®–∞—Ö—Ç—ë—Ä'}];
let aucId=5,aucFilter='all',aucSort='price',aucSearch='',aucExec=false;
let stepTimer=null,gatherTimer=null,travelTimer=null;
const $=id=>document.getElementById(id);
const updHdr=()=>{$('hdrHp').style.width=(G.p.hp/G.p.maxHp*100)+'%';$('hdrGold').textContent=G.p.gold};

// UTILS
function getBagItem(){const uid=G.p.eq.bag;if(!uid)return null;const s=G.p.inv.find(i=>i.uid===uid);return s?ITEMS[s.id]:null}
function getSlots(){const b=getBagItem();return b?b.slots:4}
function getTotalWeight(){
  let w=0;
  G.p.inv.forEach(i=>{
    const it=ITEMS[i.id];
    if(isEquippedUid(i.uid)) w+=it.weight*i.qty*0.05; // 5% weight for equipped
    else w+=it.weight*i.qty;
  });
  return w;
}
function getWeightStage(){
  const b=getBagItem();if(!b)return'over';
  const w=getTotalWeight();
  if(w<=b.wNorm)return'normal';
  if(w<=b.wMed)return'medium';
  if(w<=b.wHeavy)return'heavy';
  return'over';
}
function getStepTime(){const s=getWeightStage();return s==='over'?Infinity:CFG.stepTimes[s]}
function hasTool(res){const t=Object.entries(ITEMS).find(([k,v])=>v.gathers===res);return t&&G.p.inv.some(i=>i.id===t[0])}
function addToInv(id,qty=1){
  const it=ITEMS[id];
  for(let s of G.p.inv){if(s.id===id&&s.qty<it.stack){const add=Math.min(qty,it.stack-s.qty);s.qty+=add;qty-=add;if(qty<=0)return true}}
  // Check capacity - only counts unequipped items for slot limit? Usually MMOs count slots. Let's count unequipped stacks.
  const slots=getSlots();
  const occupied=G.p.inv.filter(i=>!isEquippedUid(i.uid)).length;
  
  if(occupied<slots || qty<=0){
     while(qty>0){
       if(G.p.inv.filter(i=>!isEquippedUid(i.uid)).length >= slots) break; 
       const add=Math.min(qty,it.stack);G.p.inv.push({id,qty:add,uid:nextUid++});qty-=add
     }
  }
  return qty<=0;
}
function countItem(id){return G.p.inv.reduce((s,i)=>s+(i.id===id?i.qty:0),0)}
function removeItem(id,qty=1){for(let i=G.p.inv.length-1;i>=0&&qty>0;i--){if(G.p.inv[i].id===id){const rem=Math.min(qty,G.p.inv[i].qty);G.p.inv[i].qty-=rem;qty-=rem;if(G.p.inv[i].qty<=0)G.p.inv.splice(i,1)}}}
function isEquippedUid(uid){return Object.values(G.p.eq).includes(uid)}

// NAV
function nav(s){
  document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  if(s==='Inv'){
    $('sInv').classList.add('active');
    document.querySelectorAll('.nav-item')[0].classList.add('active');
    renderInv();
  }else if(s==='Mast'){
    $('sMast').classList.add('active');
    document.querySelectorAll('.nav-item')[2].classList.add('active');
    renderMast();
  }else if(s==='Center'){
    if(LOCS[G.loc].isCity) renderCity(); else renderWorld();
    $('navCenter').classList.add('active');
  }else if(s==='Map'){
    $('sMap').classList.add('active');
    $('navCenter').classList.add('active');
    renderLocList();
  }
}
function updateNavCenter(){
  const inCity=LOCS[G.loc].isCity;
  $('navCenter').innerHTML=(inCity?'üè∞':'üåç')+'<span>'+(inCity?'–ì–æ—Ä–æ–¥':'–ú–∏—Ä')+'</span>';
}
function openMap(){nav('Map')}

// CITY
function renderCity(){
  $('sCity').classList.add('active');
  $('sWorld').classList.remove('active');
  updateNavCenter();
  cityTab('craft');
}
function leaveCity(){
  const first=LOC_ORDER.find(k=>!LOCS[k].isCity);
  if(first) fastTravel(first);
}

// WORLD
function renderWorld(){
  $('sCity').classList.remove('active');
  $('sWorld').classList.add('active');
  updateNavCenter();
  const L=LOCS[G.loc];
  
  // Update header info
  $('wLocName').textContent=L.name;
  $('wLocTier').textContent='–£—Ä.'+L.tier;
  const b=$('wLocPvp');
  b.className='badge '+(L.pvp==='safe'?'badge-ok':L.pvp==='request'?'badge-warn':'badge-bad');
  b.textContent=L.pvp==='safe'?'–ë–µ–∑–æ–ø–∞—Å–Ω–æ':L.pvp==='request'?'PvP –∑–∞–ø—Ä–æ—Å':'‚ö†Ô∏è PvP';

  // Chunks
  let dots='';for(let i=0;i<L.chunks;i++){let c='chunk-dot';if(i<G.chunk)c+=' done';else if(i===G.chunk)c+=' current';dots+=`<div class="${c}"></div>`}
  $('chunkBar').innerHTML=dots;
  $('chunkDesc').textContent=CFG.chunkDescs[G.chunk%CFG.chunkDescs.length];

  // Logic for step/end
  const atEnd=G.chunk>=L.chunks-1;
  const stage=getWeightStage();
  
  if(G.combat){
    $('combatCard').style.display='block';
    $('eventCard').style.display='none';
    $('stepArea').innerHTML=`<button class="btn btn-w step-btn" onclick="tryFlee()">üèÉ –£–±–µ–∂–∞—Ç—å</button><div class="step-time">–®–∞–Ω—Å 50%</div>`;
    updCombat(); // Update visual HP bars
  }else{
    $('combatCard').style.display='none';
    $('eventCard').style.display='block';
    
    if(atEnd){
      $('stepArea').style.display='none';
      $('endLocArea').style.display='block';
      const next=L.next;
      $('endLocArea').innerHTML=`<p style="text-align:center;color:var(--ok);margin-bottom:8px">–í—ã –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞!</p><div class="end-loc"><button class="btn btn-s" onclick="restartLoc()">üîÑ –ó–∞–Ω–æ–≤–æ</button><button class="btn btn-p" ${next?`onclick="goNextLoc()"`:'disabled'}>‚û°Ô∏è ${next?LOCS[next].name:'–ö–æ–Ω–µ—Ü'}</button></div>`;
    }else{
      $('endLocArea').style.display='none';
      $('stepArea').style.display='block';
      
      let btnClass='btn-p', btnText='üö∂ –°–¥–µ–ª–∞—Ç—å —à–∞–≥', timeText=`~${getStepTime()/1000} —Å–µ–∫`;
      let disabled=false;
      
      if(stage==='over'){
        btnClass='btn-d'; btnText='‚ö†Ô∏è –ü–µ—Ä–µ–≤–µ—Å!'; timeText='–°–±—Ä–æ—Å—å—Ç–µ –≤–µ—Å'; disabled=true;
      }
      
      $('stepArea').innerHTML=`<button class="btn ${btnClass} step-btn" id="stepBtn" onclick="doStep()" ${disabled?'disabled':''}><span class="step-prog" id="stepProg"></span>${btnText}</button><div class="step-time">${timeText}</div>`;
    }
  }
}

function restartLoc(){G.chunk=0;renderWorld();genEvent()}
function goNextLoc(){
  const L=LOCS[G.loc];if(!L.next)return;
  if(!G.unlocked.includes(L.next))G.unlocked.push(L.next);
  G.loc=L.next;G.chunk=0;renderWorld();genEvent();
}

function doStep(){
  if(G.traveling||G.combat||G.stepping)return;
  G.stepping=true;
  const total=getStepTime();
  let prog=0;
  $('stepBtn').disabled=true;
  stepTimer=setInterval(()=>{
    prog+=50;
    const el=$('stepProg');if(el)el.style.width=(prog/total*100)+'%';
    if(prog>=total){
      clearInterval(stepTimer);G.stepping=false;
      G.chunk++;
      renderWorld();
      genEvent();
    }
  },50);
}

// EVENTS
function genEvent(){
  const L=LOCS[G.loc],c=$('eventCard');if(!c)return;
  G.event=null;
  const r=Math.random();
  
  if(r<.3&&L.enemies?.length){
    const ek=L.enemies[Math.floor(Math.random()*L.enemies.length)],e=ENEMIES[ek];
    G.event={type:'enemy',key:ek,data:e};
    c.innerHTML=`<div class="event-icon enemy">${e.icon}</div><div class="event-title">${e.name}</div><div class="event-stats"><span style="color:var(--hp)">‚ù§Ô∏è${e.hp}</span><span style="color:var(--bad)">‚öîÔ∏è${e.dmg}</span></div><div class="event-acts"><button class="btn btn-p btn-sm" onclick="startCombat()">‚öîÔ∏è –ë–æ–π</button></div>`;
  }else if(r<.55&&L.res?.length){
    const rt=L.res[Math.floor(Math.random()*L.res.length)];
    G.event={type:'res',rt,left:4};renderGather();
  }else if(r<.7&&L.pvp!=='safe'){
    const pl=PLAYERS[Math.floor(Math.random()*PLAYERS.length)];
    G.event={type:'player',data:pl};
    c.innerHTML=`<div class="event-icon player">üë§</div><div class="event-title">${pl.name}</div><div class="event-acts"><button class="btn btn-s btn-sm" onclick="wave()">üëã</button>${L.pvp==='open'?`<button class="btn btn-d btn-sm" onclick="attackPlayer()">‚öîÔ∏è</button>`:''}</div>`;
  }else c.innerHTML=`<div class="event-icon">üåø</div><div class="event-title">–ü—É—Å—Ç–æ</div>`;
}

function renderGather(){
  const e=G.event;if(!e||e.type!=='res')return;
  const rt=e.rt,has=hasTool(rt),it=ITEMS[rt];
  $('eventCard').innerHTML=`<div class="event-icon res">${it.icon}</div><div class="event-title">${it.name} (${e.left}/4)</div>${has?`<button class="btn btn-p" onmousedown="startGather()" onmouseup="stopGather()" onmouseleave="stopGather()" ontouchstart="startGather()" ontouchend="stopGather()">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ</button><div class="gather-prog"><div class="gather-prog-fill" id="gatherProg"></div></div>`:`<p style="color:var(--bad);margin:8px">–ù—É–∂–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!</p>`}`;
}

let gatherProg=0;
function startGather(){
  if(gatherTimer||!G.event)return;gatherProg=100;
  gatherTimer=setInterval(()=>{
    gatherProg-=5;$('gatherProg').style.width=gatherProg+'%';
    if(gatherProg<=0){
      if(!addToInv(G.event.rt,1)){stopGather();$('eventCard').innerHTML+=`<p style="color:var(--bad)">–°—É–º–∫–∞ –ø–æ–ª–Ω–∞!</p>`;return}
      G.event.left--;
      if(G.event.left<=0){stopGather();$('eventCard').innerHTML=`<div class="event-icon res">${ITEMS[G.event.rt].icon}</div><div class="event-title">–°–æ–±—Ä–∞–Ω–æ!</div>`;G.event=null}
      else{gatherProg=100;renderGather()}
    }
  },50);
}
function stopGather(){if(gatherTimer){clearInterval(gatherTimer);gatherTimer=null}}
function wave(){$('eventCard').innerHTML+='<p style="color:var(--dim);margin-top:8px">üëã</p>'}
function attackPlayer(){if(!G.event?.data)return;const pl=G.event.data;G.combat={...pl,hp:pl.hp,maxHp:pl.hp,isPvP:1};startCombatUI()}

// COMBAT
function startCombat(){
  if(!G.event?.data)return;
  const e=G.event.data;
  G.combat={...e,hp:e.hp,maxHp:e.hp};
  startCombatUI();
}
function startCombatUI(){
  renderWorld(); // Switch logic
  $('cEnemyAva').textContent=G.combat.icon||'üë§';
  $('cEnemyName').textContent=G.combat.name;
  G.turn='player';
  updCombat();
  renderAbils();
  $('combatLog').innerHTML='';
  $('turnInd').textContent='–í–∞—à —Ö–æ–¥';
}
function tryFlee(){
  if(Math.random()<.5){
    G.combat=null;
    renderWorld();
    $('eventCard').innerHTML=`<div class="event-icon">üèÉ</div><div class="event-title">–°–±–µ–∂–∞–ª–∏!</div>`;
  }else{
    $('combatLog').innerHTML+='<div class="log-dmg">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±–µ–∂–∞—Ç—å!</div>';
  }
}
function updCombat(){
  const c=G.combat;if(!c)return;
  $('cEnemyHp').style.width=(c.hp/c.maxHp*100)+'%';
  $('cEnemyHpTxt').textContent=`${Math.max(0,c.hp)}/${c.maxHp}`;
  $('cPlayerHp').style.width=(G.p.hp/G.p.maxHp*100)+'%';
  $('cPlayerHpTxt').textContent=`${G.p.hp}/${G.p.maxHp}`;
  updHdr();
}
function renderAbils(){
  let abs=[];
  const eq=G.p.eq;
  // Get items by UID
  const main=G.p.inv.find(i=>i.uid===eq.mainHand);
  const off=G.p.inv.find(i=>i.uid===eq.offHand);
  const chest=G.p.inv.find(i=>i.uid===eq.chest);
  const boots=G.p.inv.find(i=>i.uid===eq.boots);
  
  if(main&&ITEMS[main.id].ab) ITEMS[main.id].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));
  else abs.push({key:'punch',...ABILS.punch});
  
  if(off&&ITEMS[off.id].ab) ITEMS[off.id].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));
  if(chest&&ITEMS[chest.id].ab) ITEMS[chest.id].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));
  if(boots&&ITEMS[boots.id].ab) ITEMS[boots.id].ab.forEach(a=>abs.push({key:a,...ABILS[a]}));
  
  while(abs.length<4) abs.push({key:'wait',...ABILS.wait});
  abs=abs.slice(0,4);
  
  $('abilGrid').innerHTML=abs.map(a=>`<button class="abil-btn" onclick="useAbil('${a.key}')" ${G.turn!=='player'?'disabled':''}><div class="abil-name">${a.icon}${a.name}</div><div class="abil-desc">${a.desc}</div></button>`).join('');
}
function useAbil(k){
  if(G.turn!=='player'||!G.combat)return;
  const a=ABILS[k],c=G.combat,log=$('combatLog');
  G.turn='wait'; $('turnInd').textContent='...'; renderAbils();
  
  setTimeout(()=>{
    if(a.dmg){c.hp-=a.dmg;log.innerHTML+=`<div class="log-dmg">‚Üí${a.name}:${a.dmg}</div>`}
    if(a.heal){G.p.hp=Math.min(G.p.maxHp,G.p.hp+a.heal);log.innerHTML+=`<div class="log-heal">‚Üí+${a.heal}</div>`}
    updCombat();
    
    if(c.hp<=0){endCombat(1);return}
    G.turn='enemy';$('turnInd').textContent='–í—Ä–∞–≥...';
    
    setTimeout(()=>{
      let dmg=a.evade?0:Math.max(0,c.dmg-(a.def||0));
      if(dmg>0){G.p.hp-=dmg;log.innerHTML+=`<div class="log-dmg">‚Üê${dmg}</div>`}
      updCombat();
      if(G.p.hp<=0){endCombat(0);return}
      G.turn='player';$('turnInd').textContent='–í–∞—à —Ö–æ–¥';renderAbils();
      log.scrollTop=log.scrollHeight;
    },500);
  },500);
}
function endCombat(win){
  const c=G.combat;G.combat=null;
  renderWorld(); // Restore normal view
  if(win){
    let loot='';const hasKnife=hasTool('leather');
    c.loot?.forEach(l=>{
      if(ITEMS[l]&&ITEMS[l].type!=='res'){if(addToInv(l,1))loot+=`<div>üéÅ${ITEMS[l].name}</div>`}
      else if(l==='leather'){if(hasKnife&&addToInv('leather',1))loot+=`<div>ü¶¥+1</div>`}
      else if(addToInv(l,1))loot+=`<div>${ITEMS[l].icon}+1</div>`;
    });
    const gold=Math.floor(Math.random()*15)+5;G.p.gold+=gold;
    $('eventCard').innerHTML=`<div class="event-icon res">üéâ</div><div class="event-title">–ü–æ–±–µ–¥–∞!</div><div style="color:var(--ok);margin:8px">${loot}<div style="color:var(--accent)">üí∞+${gold}</div></div>`;
  }else{
    if(c.isPvP&&LOCS[G.loc].pvp==='open'){G.p.eq={mainHand:null,offHand:null,chest:null,boots:null,bag:null,cloak:null};G.p.inv=[];}
    G.p.hp=Math.floor(G.p.maxHp*.5);
    G.loc='city';G.chunk=0;renderCity();
  }
  updHdr();
}

// TRAVEL
function fastTravel(target){
  if(G.traveling||G.combat)return;
  closeMod();
  
  let totalTime;
  if(target==='city'){
    totalTime=CFG.cityTeleport;
  }else{
    // Calc logic
    const curIdx=LOC_ORDER.indexOf(G.loc),tgtIdx=LOC_ORDER.indexOf(target);
    if(curIdx===-1) return; 
    let chunks=0;
    if(!LOCS[G.loc].isCity) chunks = LOCS[G.loc].chunks-G.chunk-1; // finish current
    if(curIdx<tgtIdx){for(let i=curIdx+1;i<tgtIdx;i++)chunks+=LOCS[LOC_ORDER[i]].chunks}
    else{for(let i=curIdx-1;i>=tgtIdx;i--)chunks+=LOCS[LOC_ORDER[i]].chunks}
    chunks=Math.max(1,chunks);
    const st=getStepTime();
    if(st===Infinity){alert('–ü–µ—Ä–µ–≤–µ—Å!');return}
    totalTime=chunks*st;
  }
  
  G.traveling=true;
  $('travelBar').style.display='block';
  $('travelText').textContent='–ü—É—Ç—å –≤ '+LOCS[target].name;
  
  let elapsed=0;
  travelTimer=setInterval(()=>{
    elapsed+=100;
    $('travelProg').style.width=(elapsed/totalTime*100)+'%';
    $('travelTime').textContent=Math.ceil((totalTime-elapsed)/1000)+' —Å–µ–∫';
    
    if(elapsed>=totalTime){
      clearInterval(travelTimer);
      G.traveling=false;
      $('travelBar').style.display='none';
      G.loc=target;G.chunk=0;
      nav('Center');
    }
  },100);
}
function showTravelMod(loc){
  if(loc===G.loc)return;
  // Calculate preview time
  let timeStr="~3 —Å–µ–∫";
  if(loc!=='city'){
    const curIdx=LOC_ORDER.indexOf(G.loc),tgtIdx=LOC_ORDER.indexOf(loc);
    let chunks=0;
    if(!LOCS[G.loc].isCity) chunks = LOCS[G.loc].chunks-G.chunk-1;
    if(curIdx<tgtIdx){for(let i=curIdx+1;i<tgtIdx;i++)chunks+=LOCS[LOC_ORDER[i]].chunks}
    else{for(let i=curIdx-1;i>=tgtIdx;i--)chunks+=LOCS[LOC_ORDER[i]].chunks}
    chunks=Math.max(1,chunks);
    const st=getStepTime();
    timeStr=st===Infinity?'–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ (–ø–µ—Ä–µ–≤–µ—Å!)':`~${Math.ceil(chunks*st/1000)} —Å–µ–∫`;
  }
  $('modTitle').textContent='–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ';
  $('modContent').innerHTML=`<p>–í: <b>${LOCS[loc].name}</b></p><p style="margin-top:8px">–í—Ä–µ–º—è: ${timeStr}</p><button class="btn btn-p" style="margin-top:12px" onclick="fastTravel('${loc}')">–í –ø—É—Ç—å</button>`;
  $('modal').classList.add('active');
}

// INV UI
function renderInv(){
  const slots=[{k:'mainHand',l:'–ü—Ä–∞–≤.'},{k:'offHand',l:'–õ–µ–≤.'},{k:'chest',l:'–ë—Ä–æ–Ω—è'},{k:'boots',l:'–û–±—É–≤—å'},{k:'bag',l:'–°—É–º–∫–∞'},{k:'cloak',l:'–ü–ª–∞—â'}];
  const icons={mainHand:'‚öîÔ∏è',offHand:'üõ°Ô∏è',chest:'üëï',boots:'üë¢',bag:'üéí',cloak:'üß•'};
  
  $('eqPanel').innerHTML=slots.map(s=>{
    const uid=G.p.eq[s.k];
    const item=uid?G.p.inv.find(i=>i.uid===uid):null;
    const it=item?ITEMS[item.id]:null;
    return `<div class="eq-slot${it?' filled':''}" onclick="eqClick('${s.k}')">${it?it.icon:icons[s.k]}<span class="eq-label">${s.l}</span></div>`;
  }).join('');
  
  const bag=getBagItem(),w=getTotalWeight(),stage=getWeightStage();
  if(bag){
    const max=bag.wMax; // Heavy threshold is the visible max
    let pct = w/max*100; 
    $('weightFill').style.width=(pct>100?100:pct)+'%';
    $('weightFill').style.background=stage==='normal'?'var(--ok)':stage==='medium'?'var(--warn)':stage==='heavy'?'var(--bad)':'#ff0000';
    $('weightMarks').innerHTML=`<div class="weight-mark" style="width:${bag.wNorm/max*100}%"></div><div class="weight-mark" style="width:${(bag.wMed-bag.wNorm)/max*100}%"></div><div class="weight-mark" style="width:${(bag.wHeavy-bag.wMed)/max*100}%"></div>`;
    $('weightText').textContent=`‚öñÔ∏è ${w.toFixed(1)} / ${max} (${((w/max)*100).toFixed(0)}%)`;
  }else{
    $('weightFill').style.width='100%';$('weightFill').style.background='#f00';$('weightText').textContent='–ù–µ—Ç —Å—É–º–∫–∏!';
  }
  $('weightStatus').textContent={normal:'–ù–æ—Ä–º–∞',medium:'–°—Ä–µ–¥–Ω–µ',heavy:'–¢—è–∂–µ–ª–æ',over:'–ü–µ—Ä–µ–≤–µ—Å!'}[stage];
  $('weightStatus').className='weight-status '+stage;
  
  const numSlots=getSlots();
  // Filter out equipped items from grid
  const visibleItems = G.p.inv.filter(i => !isEquippedUid(i.uid));
  
  let h='';
  for(let i=0;i<numSlots;i++){
    const item=visibleItems[i];
    if(item){
      const it=ITEMS[item.id];
      h+=`<div class="inv-slot" onclick="invClick(${G.p.inv.indexOf(item)})">${it.icon}${item.qty>1?`<span class="qty">x${item.qty}</span>`:''}<div class="name">${it.name}</div></div>`;
    }else h+=`<div class="inv-slot empty"></div>`;
  }
  $('invGrid').innerHTML=h;
}
function invClick(i){
  const item=G.p.inv[i];if(!item)return;
  const it=ITEMS[item.id],eq=isEquippedUid(item.uid);
  $('modTitle').textContent=it.name;
  let btns='';
  if(it.slot&&!eq) btns+=`<button class="btn btn-p" onclick="equip(${i});closeMod()">–ù–∞–¥–µ—Ç—å</button>`;
  if(eq) btns+=`<button class="btn btn-s" onclick="unequip('${it.slot}');closeMod()">–°–Ω—è—Ç—å</button>`;
  btns+=`<button class="btn btn-s btn-sm" onclick="if(confirm('–í—ã–±—Ä–æ—Å–∏—Ç—å?')) { dropItem(${i}); closeMod(); }">üóëÔ∏è</button>`;
  
  let stats='';
  if(it.dmg) stats+=`‚öîÔ∏è–£—Ä–æ–Ω: ${it.dmg} `;
  if(it.def) stats+=`üõ°Ô∏è–ó–∞—â: ${it.def} `;
  if(it.heal) stats+=`üíö–õ–µ—á: ${it.heal} `;
  
  $('modContent').innerHTML=`
    <p style="font-size:13px;color:var(--dim);margin-bottom:8px">${it.desc||''}</p>
    <div style="font-size:12px;margin-bottom:8px">
      <div>–í–µ—Å: ${it.weight}</div>
      <div>${stats}</div>
      ${it.ab?`<div style="color:var(--accent);margin-top:4px">–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏: ${it.ab.map(k=>ABILS[k].name).join(', ')}</div>`:''}
    </div>
    ${btns?'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px">'+btns+'</div>':''}
  `;
  $('modal').classList.add('active');
}
function eqClick(slot){
  const uid=G.p.eq[slot];if(!uid)return;
  const item=G.p.inv.find(i=>i.uid===uid);if(!item)return;
  const it=ITEMS[item.id];
  $('modTitle').textContent=it.name;
  $('modContent').innerHTML=`
    <p style="font-size:13px;color:var(--dim);margin-bottom:8px">${it.desc||''}</p>
    <button class="btn btn-s" onclick="unequip('${slot}');closeMod()">–°–Ω—è—Ç—å</button>
  `;
  $('modal').classList.add('active');
}
function equip(i){
  const item=G.p.inv[i],it=ITEMS[item.id];
  if(it.slot==='bag'){
     // Bag swap logic: Check if new capacity >= current unequipped items
     const newCap = it.slots;
     const currentItems = G.p.inv.filter(x => !isEquippedUid(x.uid) && x !== item).length; // items currently in bag, excluding the bag itself (since it will be equipped)
     // Actually, if we equip the bag, it leaves the inventory list visually, but conceptually items are "in" it.
     // Wait, simple check: `inv.length - equipped_count` vs `newCap`.
     // If we equip this bag, it becomes equipped. The OLD bag becomes unequipped.
     // So total unequipped items = (current - 1 (this bag) + 1 (old bag)).
     let resultingCount = G.p.inv.filter(x => !isEquippedUid(x.uid)).length - 1; 
     if(G.p.eq.bag) resultingCount++; 
     
     if(resultingCount > newCap) {
        alert(`–ù–µ –≤–ª–µ–∑–∞–µ—Ç! –í–µ—â–µ–π: ${resultingCount}, —Å–ª–æ—Ç–æ–≤ –±—É–¥–µ—Ç: ${newCap}`);
        return;
     }
  }
  
  if(it.two) G.p.eq.offHand=null;
  // If swapping bag, unequip old first
  if(it.slot==='bag' && G.p.eq.bag) {
      // old bag goes to inv
  }
  G.p.eq[it.slot]=item.uid;
  renderInv();
}
function unequip(slot){
  if(slot==='bag'){
     // Check basic slots (4)
     const baseSlots = 4;
     const currentItems = G.p.inv.filter(x => !isEquippedUid(x.uid)).length + 1; // +1 because bag becomes item
     if(currentItems > baseSlots){
        alert(`–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å! –í–µ—â–µ–π: ${currentItems}, –±–∞–∑–æ–≤—ã—Ö —Å–ª–æ—Ç–æ–≤: ${baseSlots}`);
        return;
     }
  }
  G.p.eq[slot]=null;
  renderInv();
}
function dropItem(i){
  const item=G.p.inv[i];
  if(isEquippedUid(item.uid)){
    for(let k in G.p.eq) if(G.p.eq[k]===item.uid) G.p.eq[k]=null;
  }
  G.p.inv.splice(i,1);renderInv();
}
function closeMod(){$('modal').classList.remove('active')}

// MAP UI
function renderLocList(){
  $('locList').innerHTML=LOC_ORDER.map(k=>{
    const L=LOCS[k],cur=k===G.loc,unlocked=G.unlocked.includes(k);
    return`<div class="loc-item${cur?' current':''}${!unlocked?' locked':''}" onclick="${unlocked?`showTravelMod('${k}')`:''}">
      <div style="font-size:20px">${L.icon}</div><div style="flex:1"><div style="font-weight:600">${L.name}</div><div style="font-size:11px;color:var(--dim)">${L.isCity?'–ì–æ—Ä–æ–¥':'–£—Ä.'+L.tier}</div></div>
    </div>`;
  }).join('');
}

// CITY TABS
function cityTab(t){
  document.querySelectorAll('#cityTabs .tab').forEach((x,i)=>x.classList.toggle('active',t==='craft'&&!i||t==='bank'&&i===1||t==='auc'&&i===2));
  if(t==='craft')renderCraft();else if(t==='bank')renderBank();else renderAuc();
}
function renderCraft(cat='weapons'){
  const cats={weapons:['wooden_sword','iron_sword','wooden_bow','wooden_staff','wooden_shield'],armor:['cloth_robe','leather_armor','plate_armor','cloth_boots','leather_boots','plate_boots'],tools:['pickaxe','axe','sickle','skinning_knife'],bags:['basic_bag','large_bag','basic_cloak']};
  let h=`<div class="tabs"><button class="tab${cat==='weapons'?' active':''}" onclick="renderCraft('weapons')">–û—Ä—É–∂–∏–µ</button><button class="tab${cat==='armor'?' active':''}" onclick="renderCraft('armor')">–ë—Ä–æ–Ω—è</button><button class="tab${cat==='tools'?' active':''}" onclick="renderCraft('tools')">–ò–Ω—Å—Ç—Ä.</button><button class="tab${cat==='bags'?' active':''}" onclick="renderCraft('bags')">–°—É–º–∫–∏</button></div>`;
  h+=cats[cat].map(k=>{const it=ITEMS[k],rec=RECIPES[k];const can=Object.entries(rec).every(([r,n])=>countItem(r)>=n);const reqs=Object.entries(rec).map(([r,n])=>`<span class="craft-req ${countItem(r)>=n?'ok':'no'}">${ITEMS[r].icon}${countItem(r)}/${n}</span>`).join('');return`<div class="craft-item"><div class="craft-icon">${it.icon}</div><div class="craft-info"><div class="craft-name">${it.name}</div><div class="craft-reqs">${reqs}</div></div><button class="btn btn-sm${can?' btn-p':' btn-s'}" onclick="craft('${k}')"${can?'':' disabled'}>+</button></div>`}).join('');
  $('cityContent').innerHTML=h;
}
function craft(k){const rec=RECIPES[k];for(const[r,n]of Object.entries(rec))if(countItem(r)<n)return;for(const[r,n]of Object.entries(rec))removeItem(r,n);addToInv(k,1);renderCraft()}

function renderBank(){
  $('cityContent').innerHTML=`<div class="card-title">–ë–∞–Ω–∫</div><div class="bank-grid">${G.p.bank.map((b,i)=>`<div class="inv-slot" onclick="bankItemClick(${i},'take')">${ITEMS[b.id].icon}${b.qty>1?`<span class="qty">x${b.qty}</span>`:''}</div>`).join('')||'<div style="text-align:center;grid-column:span 4;padding:10px;color:var(--muted)">–ü—É—Å—Ç–æ</div>'}</div>
  <div class="card-title" style="margin-top:12px">–ü–æ–ª–æ–∂–∏—Ç—å</div><div class="bank-grid">${G.p.inv.filter(i=>!isEquippedUid(i.uid)).map((s,idx)=>`<div class="inv-slot" onclick="bankItemClick(${G.p.inv.indexOf(s)},'put')">${ITEMS[s.id].icon}${s.qty>1?`<span class="qty">x${s.qty}</span>`:''}</div>`).join('')||'<div style="text-align:center;grid-column:span 4;padding:10px;color:var(--muted)">–ü—É—Å—Ç–æ</div>'}</div>`;
}
function bankItemClick(idx,action){
  const arr=action==='take'?G.p.bank:G.p.inv;
  const item=arr[idx];
  $('modTitle').textContent=(action==='take'?'–ó–∞–±—Ä–∞—Ç—å ':'–ü–æ–ª–æ–∂–∏—Ç—å ')+ITEMS[item.id].name;
  $('modContent').innerHTML=`<div class="qty-input"><div class="qty-btns"><button onclick="$('qval').value=1">1</button><button onclick="$('qval').value=${item.qty}">–í—Å–µ</button></div><input type="number" id="qval" value="${item.qty}" min="1" max="${item.qty}"></div><button class="btn btn-p" onclick="bankExec(${idx},'${action}')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`;
  $('modal').classList.add('active');
}
function bankExec(idx,action){
  const qty=parseInt($('qval').value)||1;
  if(action==='put'){
    const item=G.p.inv[idx];if(!item||item.qty<qty)return;
    const id=item.id;
    // Stack in bank
    let existing=G.p.bank.find(b=>b.id===id&&b.qty<ITEMS[id].stack);
    if(existing){
       const canAdd=Math.min(qty,ITEMS[id].stack-existing.qty);
       existing.qty+=canAdd;
       if(qty>canAdd) G.p.bank.push({id,qty:qty-canAdd,uid:nextUid++});
    } else {
       G.p.bank.push({id,qty,uid:nextUid++});
    }
    item.qty-=qty; if(item.qty<=0) G.p.inv.splice(idx,1);
  }else{
    const item=G.p.bank[idx];if(!item||item.qty<qty)return;
    if(addToInv(item.id,qty)){
       item.qty-=qty; if(item.qty<=0) G.p.bank.splice(idx,1);
    }
  }
  closeMod();renderBank();
}

function renderAuc(){
  const grouped={};
  AUC.forEach(a=>{if(!grouped[a.item])grouped[a.item]={item:a.item,orders:[],minPrice:a.price};grouped[a.item].orders.push(a);if(a.price<grouped[a.item].minPrice)grouped[a.item].minPrice=a.price});
  let items=Object.values(grouped).filter(g=>{
    const it=ITEMS[g.item];
    if(aucFilter==='res'&&it.type!=='res')return false;
    if(aucFilter==='eq'&&it.type==='res')return false;
    if(aucSearch&&!it.name.toLowerCase().includes(aucSearch.toLowerCase()))return false;
    return true;
  });
  if(aucSort==='price')items.sort((a,b)=>a.minPrice-b.minPrice);

  $('cityContent').innerHTML=`<div class="auc-filters">
    <select onchange="aucFilter=this.value;renderAuc()"><option value="all">–í—Å–µ</option><option value="res"${aucFilter==='res'?' selected':''}>–†–µ—Å—É—Ä—Å—ã</option><option value="eq"${aucFilter==='eq'?' selected':''}>–°–Ω–∞—Ä.</option></select>
    <input type="text" placeholder="–ü–æ–∏—Å–∫" value="${aucSearch}" oninput="aucSearch=this.value;renderAuc()">
    <label class="toggle"><input type="checkbox" ${aucExec?'checked':''} onchange="aucExec=this.checked;renderAuc()">–¢–µ—Å—Ç</label>
  </div>
  <div class="card-title">–ö—É–ø–∏—Ç—å</div>${items.map(g=>{const it=ITEMS[g.item];return`<div class="auc-group"><div class="auc-group-head" onclick="$('auco_${g.item}').classList.toggle('open')"><div class="auc-icon">${it.icon}</div><div class="auc-group-info"><div class="auc-group-name">${it.name}</div><div class="auc-group-meta">${g.orders.length} –ª–æ—Ç.</div></div><div class="auc-group-price">–æ—Ç üí∞${g.minPrice}</div></div><div class="auc-orders" id="auco_${g.item}">${g.orders.sort((a,b)=>a.price-b.price).map(o=>`<div class="auc-order"><div class="auc-order-info">${o.seller}</div><div class="auc-order-price">üí∞${o.price}</div>${aucExec&&o.seller==='–í—ã'?`<button class="btn btn-sm btn-s" onclick="execOrder(${o.id})">–ò—Å–ø–æ–ª–Ω.</button>`:`<button class="btn btn-sm${G.p.gold>=o.price?' btn-p':' btn-s'}" onclick="buyAuc(${o.id})"${G.p.gold>=o.price?'':' disabled'}>–ö—É–ø–∏—Ç—å</button>`}</div>`).join('')}</div></div>`}).join('')}
  <div class="card-title" style="margin-top:12px">–ü—Ä–æ–¥–∞—Ç—å</div>${G.p.inv.filter(i=>!isEquippedUid(i.uid)).map(s=>`<div class="craft-item"><div class="craft-icon">${ITEMS[s.id].icon}</div><div class="craft-info"><div class="craft-name">${ITEMS[s.id].name}</div></div><button class="btn btn-sm btn-s" onclick="showSell(${G.p.inv.indexOf(s)})">–ü—Ä–æ–¥–∞—Ç—å</button></div>`).join('')}`;
}
function showSell(idx){
  const item=G.p.inv[idx];
  $('modTitle').textContent='–ü—Ä–æ–¥–∞—Ç—å '+ITEMS[item.id].name;
  $('modContent').innerHTML=`<div class="qty-input"><div class="qty-btns"><button onclick="$('sq').value=1">1</button><button onclick="$('sq').value=${item.qty}">–í—Å–µ</button></div><input type="number" id="sq" value="1" max="${item.qty}"></div><div class="qty-input"><span>–¶–µ–Ω–∞:</span><input type="number" id="sp" value="10"></div><button class="btn btn-p" onclick="sellAuc(${idx})">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>`;
  $('modal').classList.add('active');
}
function sellAuc(idx){
  const qty=parseInt($('sq').value)||1,price=parseInt($('sp').value)||10;
  const item=G.p.inv[idx];if(!item||item.qty<qty)return;
  item.qty-=qty;if(item.qty<=0)G.p.inv.splice(idx,1);
  for(let i=0;i<qty;i++) AUC.push({id:aucId++,item:item.id,price,seller:'–í—ã'});
  closeMod();renderAuc();
}
function buyAuc(id){
  const idx=AUC.findIndex(a=>a.id===id);if(idx<0)return;
  const a=AUC[idx];if(G.p.gold<a.price)return;
  G.p.gold-=a.price;addToInv(a.item,1);AUC.splice(idx,1);updHdr();renderAuc();
}
function execOrder(id){
  const idx=AUC.findIndex(a=>a.id===id);if(idx<0)return;
  G.p.gold+=AUC[idx].price;AUC.splice(idx,1);updHdr();renderAuc();
}

function renderMast(){
  const icons={sword:'‚öîÔ∏è',bow:'üèπ',staff:'ü™Ñ',cloth:'üëò',leather:'ü¶∫',plate:'üõ°Ô∏è'};
  $('mastList').innerHTML=Object.entries(G.p.mast).map(([k,m])=>{
    const need=m.lv*100,pct=Math.min(100,m.xp/need*100);
    return`<div class="mast-item"><div class="mast-icon">${icons[k]}</div><div class="mast-info"><div class="mast-head"><span>${k}</span><span class="mast-lv">–£—Ä.${m.lv}</span></div><div class="mast-bar"><div class="mast-bar-fill" style="width:${pct}%"></div></div></div></div>`;
  }).join('');
}

// INITIALIZATION
// Manually init bag first to avoid overflow checks
const startBag = {id:'basic_bag', qty:1, uid:nextUid++};
G.p.inv.push(startBag);
G.p.eq.bag = startBag.uid;
// Add rest
initList.forEach(i=>{
    if(i.id!=='basic_bag') addToInv(i.id,i.qty);
});
// Equip default sword
const sw = G.p.inv.find(i=>i.id==='wooden_sword');
if(sw) G.p.eq.mainHand = sw.uid;

updHdr();
nav('Center');
</script>
</body>
</html>
