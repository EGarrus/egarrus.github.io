<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MMORPG</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1d23;--card:#23272f;--border:#363b44;--text:#e8e6e3;--dim:#9a9fa8;--muted:#5c6370;--accent:#c9a227;--hp:#c94a4a;--xp:#8b5cf6;--ok:#4ade80;--bad:#ef4444;--warn:#f59e0b}
html,body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;height:100%;width:100%}
body{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none}
.hdr{background:var(--card);padding:10px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.avatar{width:40px;height:40px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid var(--accent)}
.hdr-info{flex:1}.hdr-name{font-weight:600;font-size:14px}
.bar{height:6px;background:#3d2a2a;border-radius:3px;margin-top:4px}.bar-fill{height:100%;border-radius:3px;transition:width .3s}.bar-hp{background:var(--hp)}
.gold{display:flex;align-items:center;gap:4px;color:var(--accent);font-weight:600}
.main{flex:1;overflow-y:auto;padding:12px;padding-bottom:70px}
.screen{display:none}.screen.active{display:block}
.card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border)}
.card-title{font-size:12px;font-weight:600;color:var(--dim);text-transform:uppercase;margin-bottom:10px}
.btn{padding:10px 14px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn-p{background:var(--accent);color:#000}.btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-d{background:var(--bad);color:#fff}.btn:disabled{opacity:.4;cursor:not-allowed}.btn-sm{padding:6px 10px;font-size:12px}
.tabs{display:flex;gap:4px;margin-bottom:12px;background:var(--bg);padding:4px;border-radius:8px}
.tab{flex:1;padding:8px;background:none;border:none;border-radius:6px;color:var(--dim);font-size:12px;cursor:pointer}.tab.active{background:var(--card);color:var(--text)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-ok{background:rgba(74,222,128,.2);color:var(--ok)}.badge-warn{background:rgba(245,158,11,.2);color:var(--warn)}.badge-bad{background:rgba(239,68,68,.2);color:var(--bad)}
.map-view{position:relative;height:200px;background:var(--bg);border-radius:8px;overflow:hidden;margin-bottom:10px}
.map-node{position:absolute;width:24px;height:24px;background:var(--card);border:2px solid var(--border);border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
.map-node.current{border-color:var(--accent);background:var(--accent);color:#000}
.map-node.exit{border-color:var(--ok)}
.map-path{position:absolute;background:var(--border);height:2px;transform-origin:left center}
.map-player{position:absolute;font-size:16px;transform:translate(-50%,-50%);z-index:10;transition:all .5s}
.step-btn{width:100%;padding:14px;position:relative;overflow:hidden}
.step-prog{position:absolute;left:0;top:0;height:100%;background:rgba(255,255,255,.2);width:0;transition:width .1s linear}
.event{text-align:center;padding:16px}
.event-icon{width:64px;height:64px;margin:0 auto 12px;background:var(--bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;border:2px solid var(--border)}
.event-icon.enemy{border-color:var(--bad)}.event-icon.res{border-color:var(--ok)}.event-icon.player{border-color:var(--xp)}
.event-title{font-size:16px;font-weight:700;margin-bottom:6px}
.event-stats{display:flex;justify-content:center;gap:12px;font-size:13px;color:var(--dim);margin:8px 0}
.event-acts{display:flex;gap:6px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.gather-btn{width:100%;padding:16px;position:relative;touch-action:none}
.gather-prog{height:4px;background:var(--bg);border-radius:2px;margin-top:8px;overflow:hidden}
.gather-prog-fill{height:100%;background:var(--ok);transition:width .05s linear}
.combat{background:linear-gradient(180deg,#2a1f1f,var(--card));border-color:var(--bad)}
.fighter{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px}
.fighter-ava{width:44px;height:44px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px}
.fighter-info{flex:1}.fighter-name{font-weight:600;font-size:13px;margin-bottom:4px}
.fighter-hp{height:10px;background:#3d2a2a;border-radius:5px;overflow:hidden;position:relative}
.fighter-hp-fill{height:100%;background:linear-gradient(90deg,#b91c1c,var(--hp));transition:width .3s}
.fighter-hp-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;font-weight:700}
.abilities{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px}
.abil-btn{padding:10px 8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left}
.abil-btn:hover{border-color:var(--accent)}.abil-btn:disabled{opacity:.5}
.abil-name{font-weight:600;font-size:12px}.abil-desc{font-size:10px;color:var(--muted)}
.turn-indicator{text-align:center;padding:8px;font-size:12px;color:var(--accent);font-weight:600}
.log{max-height:80px;overflow-y:auto;background:var(--bg);border-radius:6px;padding:8px;margin-top:10px;font-size:11px}
.log-dmg{color:var(--bad)}.log-heal{color:var(--ok)}
.inv-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.inv-slot{aspect-ratio:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;font-size:20px;position:relative}
.inv-slot:hover{border-color:var(--accent)}.inv-slot.empty{opacity:.3;cursor:default}
.inv-slot.eq{border-color:var(--accent);background:rgba(201,162,39,.1)}
.inv-slot .eq-dot{position:absolute;top:3px;right:3px;width:6px;height:6px;background:var(--accent);border-radius:50%}
.inv-slot .name{font-size:8px;color:var(--dim);text-align:center;line-height:1.1;margin-top:2px}
.eq-panel{display:flex;justify-content:center;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.eq-slot{width:48px;height:48px;background:var(--bg);border:1px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--muted)}
.eq-slot.filled{border-style:solid;border-color:var(--accent);color:var(--text)}
.res-bar{display:flex;gap:4px;flex-wrap:wrap}
.res-item{display:flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg);border-radius:6px;font-size:12px}
.loc-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;cursor:pointer}
.loc-item:hover{border-color:var(--accent)}.loc-item.current{border-color:var(--ok)}
.craft-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:10px;margin-bottom:6px}
.craft-icon{width:40px;height:40px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.craft-info{flex:1}.craft-name{font-weight:600;font-size:13px}
.craft-reqs{display:flex;gap:6px;font-size:11px;margin-top:2px;flex-wrap:wrap}
.craft-req{padding:2px 5px;background:var(--card);border-radius:3px}.craft-req.ok{color:var(--ok)}.craft-req.no{color:var(--bad)}
.mast-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px}
.mast-icon{width:36px;height:36px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px}
.mast-info{flex:1}.mast-head{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}.mast-lv{color:var(--xp);font-weight:600}
.mast-bar{height:4px;background:var(--bg);border-radius:2px}.mast-bar-fill{height:100%;background:var(--xp);border-radius:2px}
.auc-filters{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.auc-filters select,.auc-filters input{padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}
.auc-filters input[type=text]{flex:1;min-width:80px}
.auc-group{background:var(--bg);border-radius:8px;margin-bottom:6px;overflow:hidden}
.auc-group-head{display:flex;align-items:center;gap:8px;padding:10px;cursor:pointer}
.auc-group-head:hover{background:var(--card)}
.auc-icon{width:32px;height:32px;background:var(--card);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px}
.auc-group-info{flex:1}.auc-group-name{font-weight:600;font-size:13px}.auc-group-meta{font-size:10px;color:var(--muted)}
.auc-group-price{color:var(--accent);font-weight:600;font-size:13px}
.auc-orders{padding:0 10px 10px;display:none}.auc-orders.open{display:block}
.auc-order{display:flex;align-items:center;gap:8px;padding:6px;background:var(--card);border-radius:6px;margin-bottom:4px;font-size:12px}
.auc-order-info{flex:1}.auc-order-price{color:var(--accent)}
.bank-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal.active{display:flex}
.modal-box{background:var(--card);border-radius:12px;padding:16px;width:100%;max-width:320px;max-height:80vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.modal-title{font-size:16px;font-weight:700}.modal-close{width:28px;height:28px;background:var(--bg);border:none;border-radius:6px;color:var(--dim);cursor:pointer;font-size:16px}
.nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:var(--card);border-top:1px solid var(--border);display:flex;padding:6px}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px;background:none;border:none;color:var(--muted);cursor:pointer;border-radius:6px;font-size:10px}.nav-item.active{color:var(--accent)}
.toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--dim)}
.toggle input{width:36px;height:20px;appearance:none;background:var(--bg);border-radius:10px;position:relative;cursor:pointer}
.toggle input::after{content:'';position:absolute;width:16px;height:16px;background:var(--dim);border-radius:50%;top:2px;left:2px;transition:.2s}
.toggle input:checked{background:var(--accent)}.toggle input:checked::after{left:18px;background:#fff}
</style>
</head>
<body>
<div class="hdr">
<div class="avatar" id="avatar">üë§</div>
<div class="hdr-info"><div class="hdr-name" id="hdrName">–ò–≥—Ä–æ–∫</div><div class="bar"><div class="bar-fill bar-hp" id="hdrHp" style="width:100%"></div></div></div>
<div class="gold">üí∞ <span id="hdrGold">150</span></div>
</div>
<div class="main">
<div class="screen active" id="sExplore">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div><span id="locName" style="font-weight:700">–õ—É–≥–∞</span> <span class="badge badge-warn" id="locBadge">PvP</span></div>
<span style="font-size:11px;color:var(--dim)" id="locTier">–£—Ä.1</span>
</div>
<div class="map-view" id="mapView"></div>
<button class="btn btn-p step-btn" id="stepBtn">
<span class="step-prog" id="stepProg"></span>
<span id="stepText">üö∂ –°–¥–µ–ª–∞—Ç—å —à–∞–≥</span>
</button>
</div>
<div class="card event" id="eventCard"></div>
<div class="card combat" id="combatCard" style="display:none">
<div class="fighter"><div class="fighter-ava" id="cEnemyAva">üê∫</div><div class="fighter-info"><div class="fighter-name" id="cEnemyName">–í–æ–ª–∫</div><div class="fighter-hp"><div class="fighter-hp-fill" id="cEnemyHp"></div><span class="fighter-hp-text" id="cEnemyHpTxt"></span></div></div></div>
<div class="turn-indicator" id="turnInd">–í–∞—à —Ö–æ–¥</div>
<div class="fighter"><div class="fighter-ava">üë§</div><div class="fighter-info"><div class="fighter-name">–í—ã</div><div class="fighter-hp"><div class="fighter-hp-fill" id="cPlayerHp"></div><span class="fighter-hp-text" id="cPlayerHpTxt"></span></div></div></div>
<div class="abilities" id="abilGrid"></div>
<div class="log" id="combatLog"></div>
</div>
</div>
<div class="screen" id="sInv">
<div class="card"><div class="card-title">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div><div class="eq-panel" id="eqPanel"></div></div>
<div class="card"><div class="card-title">–†–µ—Å—É—Ä—Å—ã</div><div class="res-bar" id="resBar"></div></div>
<div class="card"><div class="card-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div class="inv-grid" id="invGrid"></div></div>
</div>
<div class="screen" id="sMap"><div class="card"><div class="card-title">–õ–æ–∫–∞—Ü–∏–∏</div><div id="locList"></div></div></div>
<div class="screen" id="sCity">
<div class="tabs" id="cityTabs"><button class="tab active" onclick="window.cityTab('craft')">–ö—Ä–∞—Ñ—Ç</button><button class="tab" onclick="window.cityTab('bank')">–ë–∞–Ω–∫</button><button class="tab" onclick="window.cityTab('auc')">–ê—É–∫—Ü–∏–æ–Ω</button></div>
<div id="cityContent"></div>
</div>
<div class="screen" id="sMast"><div class="card"><div class="card-title">–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</div><div id="mastList"></div></div></div>
</div>
<div class="nav">
<button class="nav-item active" onclick="nav('Explore',this)">üåç<span>–ú–∏—Ä</span></button>
<button class="nav-item" onclick="nav('Inv',this)">üéí<span>–°—É–º–∫–∞</span></button>
<button class="nav-item" onclick="nav('Map',this)">üó∫Ô∏è<span>–ö–∞—Ä—Ç–∞</span></button>
<button class="nav-item" onclick="nav('City',this)">üè∞<span>–ì–æ—Ä–æ–¥</span></button>
<button class="nav-item" onclick="nav('Mast',this)">üìä<span>–°–∫–∏–ª—ã</span></button>
</div>
<div class="modal" id="modal"><div class="modal-box"><div class="modal-head"><div class="modal-title" id="modTitle"></div><button class="modal-close" onclick="closeMod()">√ó</button></div><div id="modContent"></div></div></div>
<script>
// –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∫–æ–¥ –∏–≥—Ä—ã (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ ES6 –º–æ–¥—É–ª–µ–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

// ===== –ò–ì–†–û–í–´–ï –î–ê–ù–ù–´–ï =====
const LOCS = {
  city: {
    name: '–ì–æ—Ä–æ–¥', icon: 'üè∞', tier: 0, pvp: 'safe', isCity: 1,
    chunks: 1, // –ì–æ—Ä–æ–¥ - 1 —á–∞–Ω–∫
    nextLoc: null, // –ù–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
    enemies: [], res: []
  },
  meadow: {
    name: '–õ—É–≥–∞', icon: 'üåø', tier: 1, pvp: 'request',
    chunks: 10, // 10 —á–∞–Ω–∫–æ–≤
    nextLoc: 'forest', // –°–ª–µ–¥—É—é—â–∞—è –ª–æ–∫–∞—Ü–∏—è
    enemies: ['slime', 'wolf'], res: ['wood', 'cloth']
  },
  forest: {
    name: '–õ–µ—Å', icon: 'üå≤', tier: 2, pvp: 'request',
    chunks: 15, // 15 —á–∞–Ω–∫–æ–≤
    nextLoc: 'highlands',
    enemies: ['wolf', 'bear'], res: ['wood', 'leather']
  },
  highlands: {
    name: '–í—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ', icon: '‚õ∞Ô∏è', tier: 3, pvp: 'open',
    chunks: 20, // 20 —á–∞–Ω–∫–æ–≤
    nextLoc: null, // –ü–æ—Å–ª–µ–¥–Ω—è—è –ª–æ–∫–∞—Ü–∏—è
    enemies: ['golem', 'harpy'], res: ['metal', 'leather']
  }
};

const ENEMIES = {
  slime: {name: '–°–ª–∏–∑–µ–Ω—å', icon: 'üü¢', hp: 30, dmg: 5, xp: 10, loot: ['cloth']},
  wolf: {name: '–í–æ–ª–∫', icon: 'üê∫', hp: 50, dmg: 10, xp: 20, loot: ['leather']},
  bear: {name: '–ú–µ–¥–≤–µ–¥—å', icon: 'üêª', hp: 80, dmg: 15, xp: 35, loot: ['leather', 'leather']},
  golem: {name: '–ì–æ–ª–µ–º', icon: 'üóø', hp: 120, dmg: 18, xp: 50, loot: ['metal', 'metal']},
  harpy: {name: '–ì–∞—Ä–ø–∏—è', icon: 'ü¶Ö', hp: 60, dmg: 20, xp: 45, loot: ['cloth']}
};

const PLAYERS = [
  {name: '–†—ã—Ü–∞—Ä—å_42', hp: 80, dmg: 15, loot: ['iron_sword']},
  {name: 'MagicUser', hp: 60, dmg: 20, loot: ['wooden_staff']},
  {name: '–û—Ö–æ—Ç–Ω–∏–∫', hp: 70, dmg: 18, loot: ['wooden_bow']}
];

const ITEMS = {
  wooden_sword: {name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', icon: 'üó°Ô∏è', slot: 'mainHand', ab: ['slash', 'block'], cat: 'sword', desc: '–ë–∞–∑–æ–≤–æ–µ –æ—Ä—É–∂–∏–µ'},
  iron_sword: {name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', icon: '‚öîÔ∏è', slot: 'mainHand', ab: ['slash', 'parry'], cat: 'sword', desc: '–£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ—á'},
  wooden_bow: {name: '–õ—É–∫', icon: 'üèπ', slot: 'mainHand', ab: ['shoot', 'multishot'], cat: 'bow', two: 1, desc: '–°—Ç—Ä–µ–ª—è–µ—Ç –∏–∑–¥–∞–ª–µ–∫–∞'},
  wooden_staff: {name: '–ü–æ—Å–æ—Ö', icon: 'ü™Ñ', slot: 'mainHand', ab: ['fireball', 'heal'], cat: 'staff', two: 1, desc: '–ú–∞–≥–∏—á–µ—Å–∫–æ–µ –æ—Ä—É–∂–∏–µ'},
  wooden_shield: {name: '–©–∏—Ç', icon: 'üõ°Ô∏è', slot: 'offHand', ab: ['shieldblock'], cat: 'shield', desc: '–ë–ª–æ–∫–∏—Ä—É–µ—Ç —É—Ä–æ–Ω'},
  cloth_robe: {name: '–†–æ–±–∞', icon: 'üëò', slot: 'chest', ab: ['mana_shield'], cat: 'cloth', desc: '–ú–∞–≥–∏—á–µ—Å–∫–∞—è –±—Ä–æ–Ω—è'},
  leather_armor: {name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', icon: 'ü¶∫', slot: 'chest', ab: ['dodge'], cat: 'leather', desc: '–ë–∞–ª–∞–Ω—Å –∑–∞—â–∏—Ç—ã'},
  plate_armor: {name: '–õ–∞—Ç—ã', icon: 'üõ°Ô∏è', slot: 'chest', ab: ['fortify'], cat: 'plate', desc: '–ú–∞–∫—Å. –∑–∞—â–∏—Ç–∞'},
  cloth_boots: {name: '–¢–∫–∞–Ω–µ–≤—ã–µ —Å–∞–ø–æ–≥–∏', icon: 'üëü', slot: 'boots', ab: ['blink'], cat: 'cloth', desc: '–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è'},
  leather_boots: {name: '–ö–æ–∂–∞–Ω—ã–µ —Å–∞–ø–æ–≥–∏', icon: 'ü•æ', slot: 'boots', ab: ['dash'], cat: 'leather', desc: '–ë—ã—Å—Ç—Ä—ã–π —Ä—ã–≤–æ–∫'},
  plate_boots: {name: '–õ–∞—Ç–Ω—ã–µ —Å–∞–ø–æ–≥–∏', icon: 'ü¶∂', slot: 'boots', ab: ['stomp'], cat: 'plate', desc: '–û–≥–ª—É—à–∞—é—â–∏–π —É–¥–∞—Ä'},
  pickaxe: {name: '–ö–∏—Ä–∫–∞', icon: '‚õèÔ∏è', slot: 'tool', ab: [], cat: 'tool', desc: '–î–ª—è –¥–æ–±—ã—á–∏ —Ä—É–¥—ã'},
  axe: {name: '–¢–æ–ø–æ—Ä', icon: 'ü™ì', slot: 'tool', ab: [], cat: 'tool', desc: '–î–ª—è —Ä—É–±–∫–∏ –¥–µ—Ä–µ–≤–∞'},
  sickle: {name: '–°–µ—Ä–ø', icon: 'üåæ', slot: 'tool', ab: [], cat: 'tool', desc: '–î–ª—è —Å–±–æ—Ä–∞ –≤–æ–ª–æ–∫–æ–Ω'},
  skinning_knife: {name: '–ù–æ–∂ —Å–≤–µ–∂–µ–≤–∞—Ç–µ–ª—è', icon: 'üî™', slot: 'tool', ab: [], cat: 'tool', desc: '–î–ª—è —Å–Ω—è—Ç–∏—è –∫–æ–∂–∏'}
};

const ABILS = {
  punch: {name: '–£–¥–∞—Ä', icon: 'üëä', dmg: 5, desc: '–ë–µ–∑ –æ—Ä—É–∂–∏—è'},
  wait: {name: '–ñ–¥–∞—Ç—å', icon: '‚è≥', heal: 5, desc: '+5 HP'},
  slash: {name: '–†—É–±—è—â–∏–π', icon: '‚öîÔ∏è', dmg: 15, desc: '15 —É—Ä–æ–Ω–∞'},
  block: {name: '–ë–ª–æ–∫', icon: 'üõ°Ô∏è', def: 20, desc: '20 –∑–∞—â–∏—Ç—ã'},
  parry: {name: '–ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ', icon: '‚Ü©Ô∏è', dmg: 10, def: 10, desc: '10 —É—Ä–æ–Ω–∞, 10 –∑–∞—â–∏—Ç—ã'},
  shoot: {name: '–í—ã—Å—Ç—Ä–µ–ª', icon: 'üèπ', dmg: 18, desc: '18 —É—Ä–æ–Ω–∞'},
  multishot: {name: '–ó–∞–ª–ø', icon: 'üéØ', dmg: 24, desc: '24 —É—Ä–æ–Ω–∞'},
  fireball: {name: '–û–≥–Ω–µ—à–∞—Ä', icon: 'üî•', dmg: 25, desc: '25 —É—Ä–æ–Ω–∞'},
  heal: {name: '–õ–µ—á–µ–Ω–∏–µ', icon: 'üíö', heal: 30, desc: '+30 HP'},
  shieldblock: {name: '–ë–ª–æ–∫ —â–∏—Ç–æ–º', icon: 'üõ°Ô∏è', def: 25, desc: '25 –∑–∞—â–∏—Ç—ã'},
  mana_shield: {name: '–ú–∞–Ω–∞-—â–∏—Ç', icon: 'üîÆ', def: 25, desc: '25 –∑–∞—â–∏—Ç—ã'},
  dodge: {name: '–£–∫–ª–æ–Ω–µ–Ω–∏–µ', icon: 'üí®', evade: 1, desc: '–ò–∑–±–µ–∂–∞—Ç—å —É–¥–∞—Ä–∞'},
  fortify: {name: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ', icon: 'üè∞', def: 30, desc: '30 –∑–∞—â–∏—Ç—ã'},
  blink: {name: '–¢–µ–ª–µ–ø–æ—Ä—Ç', icon: '‚ú®', dmg: 15, evade: 1, desc: '15 —É—Ä–æ–Ω–∞ + —É–∫–ª–æ–Ω'},
  dash: {name: '–†—ã–≤–æ–∫', icon: 'üí®', dmg: 12, desc: '12 —É—Ä–æ–Ω–∞'},
  stomp: {name: '–¢–æ–ø–æ—Ç', icon: 'üí•', dmg: 20, desc: '20 —É—Ä–æ–Ω–∞'}
};

const RECIPES = {
  wooden_sword: {wood: 2, metal: 1}, iron_sword: {metal: 4, wood: 1},
  wooden_bow: {wood: 3}, wooden_staff: {wood: 2, cloth: 1},
  wooden_shield: {wood: 2, leather: 1}, cloth_robe: {cloth: 4},
  leather_armor: {leather: 4}, plate_armor: {metal: 4, leather: 2},
  cloth_boots: {cloth: 2}, leather_boots: {leather: 2},
  plate_boots: {metal: 2, leather: 1}, pickaxe: {wood: 1, metal: 2},
  axe: {wood: 1, metal: 2}, sickle: {wood: 1, metal: 1},
  skinning_knife: {wood: 1, metal: 1}
};

const RES_ICON = {wood: 'ü™µ', metal: 'üß±', cloth: 'üß∂', leather: 'ü¶¥'};
const RES_TOOL = {wood: 'axe', metal: 'pickaxe', cloth: 'sickle', leather: 'skinning_knife'};

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–ï–ú –ò–ì–†–´ =====
let S = null;
let saveTimeout = null;

function initGameState() {
  const saved = localStorage.getItem('mmorpg_save');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      if (data && data.p && typeof data.p.hp === 'number') {
        // –ú–∏–≥—Ä–∞—Ü–∏—è: –µ—Å–ª–∏ –µ—Å—Ç—å node, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ chunk
        if (data.node !== undefined && data.chunk === undefined) {
          data.chunk = data.node;
          delete data.node;
        }
        // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ª–æ–∫–∞—Ü–∏–π, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ
        if (!data.openedLocs) {
          data.openedLocs = ['city', 'meadow'];
        }
        // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞–Ω–∫–∞, —Å—Ç–∞–≤–∏–º 0
        if (data.chunk === undefined) {
          data.chunk = 0;
        }
        S = data;
        return;
      }
    } catch(e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
  }

  // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  S = {
    p: {
      hp: 100, maxHp: 100, gold: 150,
      res: {wood: 8, metal: 5, cloth: 3, leather: 4},
      inv: ['wooden_sword', 'leather_armor', 'pickaxe', 'axe', 'sickle', 'skinning_knife'],
      eq: {mainHand: null, offHand: null, chest: null, boots: null, tool: null},
      bank: {res: {wood: 10, metal: 0, cloth: 0, leather: 0}, items: ['cloth_robe']},
      mast: {
        sword: {lv: 3, xp: 45}, bow: {lv: 1, xp: 0}, staff: {lv: 2, xp: 80},
        cloth: {lv: 1, xp: 20}, leather: {lv: 2, xp: 10}, plate: {lv: 1, xp: 0}
      }
    },
    loc: 'meadow',
    chunk: 0, // –¢–µ–∫—É—â–∏–π —á–∞–Ω–∫ –≤ –ª–æ–∫–∞—Ü–∏–∏ (0-based)
    openedLocs: ['city', 'meadow'], // –û—Ç–∫—Ä—ã—Ç—ã–µ –ª–æ–∫–∞—Ü–∏–∏
    combat: null,
    event: null,
    turn: 'player',
    gatherLeft: 0,
    traveling: null // {toLoc: 'forest', progress: 0, totalChunks: 15} - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
  };
}

function saveGame() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    try {
      localStorage.setItem('mmorpg_save', JSON.stringify(S));
    } catch(e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
  }, 500);
}

// ===== UI –§–£–ù–ö–¶–ò–ò =====
function updHdr() {
  const hpEl = document.getElementById('hdrHp');
  const goldEl = document.getElementById('hdrGold');
  if (hpEl) hpEl.style.width = (S.p.hp / S.p.maxHp * 100) + '%';
  if (goldEl) goldEl.textContent = S.p.gold;
  saveGame();
}

function nav(s, btn) {
  document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
  const screen = document.getElementById('s' + s);
  if (screen) screen.classList.add('active');

  document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
  if (btn) btn.classList.add('active');

  if (s === 'Inv') renderInv();
  if (s === 'Map') renderLocList();
  if (s === 'City') renderCity();
  if (s === 'Mast') renderMast();
}

function closeMod() {
  const modal = document.getElementById('modal');
  if (modal) modal.classList.remove('active');
}

// ===== –î–í–ò–ñ–ï–ù–ò–ï =====
let stepProgress = 0;
let stepInterval = null;
const STEP_TIME = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —à–∞–≥

function renderMovementUI() {
  const btn = document.getElementById('stepBtn');
  const text = document.getElementById('stepText');
  const prog = document.getElementById('stepProg');

  if (!btn || !text) return;

  const L = LOCS[S.loc];
  if (!L) return;

  // –ï—Å–ª–∏ –∏–¥—ë—Ç –±—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
  if (S.traveling) {
    btn.style.display = '';
    text.textContent = `üö∂ –ò–¥—ë–º –≤ ${LOCS[S.traveling.toLoc]?.name || S.traveling.toLoc}...`;
    btn.onclick = null;
    return;
  }

  // –ï—Å–ª–∏ –≤ –≥–æ—Ä–æ–¥–µ
  if (L.isCity) {
    btn.style.display = 'none';
    return;
  }

  btn.style.display = '';

  const isLastChunk = S.chunk >= L.chunks - 1;

  if (isLastChunk) {
    // –ù–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —á–∞–Ω–∫–µ - –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ
    text.textContent = 'üèÅ –ö–æ–Ω–µ—Ü –ª–æ–∫–∞—Ü–∏–∏';
    btn.onclick = () => showLocationEnd();
  } else {
    // –û–±—ã—á–Ω—ã–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥
    text.textContent = `üö∂ –°–¥–µ–ª–∞—Ç—å —à–∞–≥ (${S.chunk + 1}/${L.chunks})`;
    btn.onclick = () => startStep();
  }
}

function startStep() {
  if (stepInterval || S.combat || S.traveling) return;

  const L = LOCS[S.loc];
  if (!L || S.chunk >= L.chunks) return;

  stepProgress = 0;
  stepInterval = setInterval(() => {
    stepProgress += 50;
    const prog = document.getElementById('stepProg');
    if (prog) prog.style.width = (stepProgress / STEP_TIME * 100) + '%';

    if (stepProgress >= STEP_TIME) {
      stopStep();
      S.chunk++;
      saveGame();
      renderMap();
      genEvent();
      renderMovementUI();
    }
  }, 50);
}

function stopStep() {
  if (stepInterval) {
    clearInterval(stepInterval);
    stepInterval = null;
  }
  stepProgress = 0;
  const prog = document.getElementById('stepProg');
  if (prog) prog.style.width = '0';
}

function goTo(loc) {
  if (!LOCS[loc]) return;
  S.loc = loc;
  S.chunk = 0;
  saveGame();
  renderMap();
  const eventCard = document.getElementById('eventCard');
  if (LOCS[loc].isCity) {
    if (eventCard) eventCard.innerHTML = `<div class="event-icon res">üè∞</div><div class="event-title">–ì–æ—Ä–æ–¥</div><p style="color:var(--dim);margin-top:8px">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ì–æ—Ä–æ–¥" –≤ –º–µ–Ω—é</p>`;
  } else {
    genEvent();
  }
}

function restartLocation() {
  S.chunk = 0;
  saveGame();
  renderMap();
  genEvent();
  renderMovementUI();
  closeMod();
}

function goToNextLocation() {
  const L = LOCS[S.loc];
  if (L && L.nextLoc) {
    S.openedLocs.push(L.nextLoc);
    goTo(L.nextLoc);
  }
  closeMod();
}

function fastTravel(targetLoc) {
  if (S.traveling || !S.openedLocs.includes(targetLoc)) return;

  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –≤ –ø—É—Ç–∏
  const currentLocIndex = S.openedLocs.indexOf(S.loc);
  const targetLocIndex = S.openedLocs.indexOf(targetLoc);

  let totalChunks = 0;
  const start = Math.min(currentLocIndex, targetLocIndex);
  const end = Math.max(currentLocIndex, targetLocIndex);

  for (let i = start; i < end; i++) {
    const loc = S.openedLocs[i];
    if (LOCS[loc]) {
      totalChunks += LOCS[loc].chunks;
    }
  }

  S.traveling = {toLoc: targetLoc, progress: 0, totalChunks: totalChunks};
  renderMovementUI();

  // –ò–º–∏—Ç–∏—Ä—É–µ–º –±—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
  const travelInterval = setInterval(() => {
    S.traveling.progress++;
    if (S.traveling.progress >= S.traveling.totalChunks) {
      clearInterval(travelInterval);
      goTo(S.traveling.toLoc);
      S.traveling = null;
      renderMovementUI();
    }
  }, 200); // –ö–∞–∂–¥—ã–µ 200ms - –æ–¥–∏–Ω —á–∞–Ω–∫
}

function showLocationEnd() {
  const modTitle = document.getElementById('modTitle');
  const modContent = document.getElementById('modContent');
  const modal = document.getElementById('modal');

  if (modTitle) modTitle.textContent = '–ö–æ–Ω–µ—Ü –ª–æ–∫–∞—Ü–∏–∏';
  if (modContent) {
    const L = LOCS[S.loc];
    let content = `<p style="margin-bottom:12px">–í—ã –ø—Ä–æ—à–ª–∏ ${L.name}!</p>`;

    if (L.nextLoc) {
      content += `<button class="btn btn-p" style="width:100%;margin-bottom:8px" onclick="goToNextLocation()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ ${LOCS[L.nextLoc].name}</button>`;
    }
    content += `<button class="btn btn-s" style="width:100%" onclick="restartLocation()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>`;

    modContent.innerHTML = content;
  }
  if (modal) modal.classList.add('active');
}

// ===== –†–ï–ù–î–ï–†–ò–ù–ì –ö–ê–†–¢–´ =====
function renderMap() {
  const L = LOCS[S.loc];
  const mv = document.getElementById('mapView');
  if (!mv || !L) return;

  const nameEl = document.getElementById('locName');
  const tierEl = document.getElementById('locTier');
  const badgeEl = document.getElementById('locBadge');

  if (nameEl) nameEl.textContent = L.name;
  if (tierEl) tierEl.textContent = L.isCity ? '–ì–æ—Ä–æ–¥' : '–£—Ä.' + L.tier;

  if (badgeEl) {
    badgeEl.className = 'badge ' + (L.pvp === 'safe' ? 'badge-ok' : L.pvp === 'request' ? 'badge-warn' : 'badge-bad');
    badgeEl.textContent = L.pvp === 'safe' ? '–ë–µ–∑–æ–ø–∞—Å–Ω–æ' : L.pvp === 'request' ? 'PvP –∑–∞–ø—Ä–æ—Å' : '‚ö†Ô∏è PvP';
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ª–æ–∫–∞—Ü–∏–∏ (–ª–∏–Ω–µ–π–Ω–∞—è –ø–æ–ª–æ—Å–∞)
  let h = '';

  if (!L.isCity) {
    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ª–æ–∫–∞—Ü–∏–∏
    const progress = ((S.chunk + 1) / L.chunks * 100);
    h += `<div style="position:absolute;bottom:10px;left:10px;right:10px;height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
      <div style="height:100%;background:var(--accent);width:${progress}%;transition:width 0.3s"></div>
    </div>`;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞–Ω–∫
    h += `<div style="position:absolute;bottom:25px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--dim)">–ß–∞–Ω–∫ ${S.chunk + 1}/${L.chunks}</div>`;
  }

  // –ò–∫–æ–Ω–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ
  h += `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px">${L.icon}</div>`;

  mv.innerHTML = h;
  renderMovementUI();
}

// ===== –°–û–ë–´–¢–ò–Ø =====
function genEvent() {
  const L = LOCS[S.loc];
  if (!L || L.isCity || S.traveling) return;

  const r = Math.random();
  const c = document.getElementById('eventCard');
  if (!c) return;

  S.event = null;

  if (r < 0.3 && L.enemies?.length) {
    const ek = L.enemies[Math.floor(Math.random() * L.enemies.length)];
    const e = ENEMIES[ek];
    if (e) {
      S.event = {type: 'enemy', key: ek, data: e};
      c.innerHTML = `<div class="event-icon enemy">${e.icon}</div><div class="event-title">${e.name}</div><div class="event-stats"><span style="color:var(--hp)">‚ù§Ô∏è${e.hp}</span><span style="color:var(--bad)">‚öîÔ∏è${e.dmg}</span></div><div class="event-acts"><button class="btn btn-p" onclick="startCombat()">‚öîÔ∏è –ë–æ–π</button><button class="btn btn-s" onclick="genEvent()">–£–±–µ–∂–∞—Ç—å</button></div>`;
    }
  } else if (r < 0.55 && L.res?.length) {
    const rt = L.res[Math.floor(Math.random() * L.res.length)];
    S.event = {type: 'res', rt, left: 4};
    S.gatherLeft = 4;
    renderGather();
  } else if (r < 0.7 && L.pvp !== 'safe') {
    const pl = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];
    if (pl) {
      S.event = {type: 'player', data: pl};
      let btns = `<button class="btn btn-s btn-sm" onclick="wave()">üëã</button>`;
      btns += L.pvp === 'open' ? `<button class="btn btn-d btn-sm" onclick="attackPlayer()">‚öîÔ∏è</button>` : `<button class="btn btn-s btn-sm" onclick="duel()">–î—É—ç–ª—å</button>`;
      c.innerHTML = `<div class="event-icon player">üë§</div><div class="event-title">${pl.name}</div><div class="event-acts">${btns}</div>`;
    }
  } else {
    c.innerHTML = `<div class="event-icon">üåø</div><div class="event-title">–ü—É—Å—Ç–æ</div>`;
  }
}

function wave() {
  const c = document.getElementById('eventCard');
  if (c) c.innerHTML += '<p style="color:var(--dim);margin-top:8px">üëã</p>';
}

function duel() {
  const c = document.getElementById('eventCard');
  if (!c) return;
  c.innerHTML = `<p style="color:var(--dim)">–û–∂–∏–¥–∞–Ω–∏–µ...</p>`;
  setTimeout(() => {
    if (Math.random() > 0.5) {
      attackPlayer();
    } else {
      if (c) c.innerHTML = `<p style="color:var(--bad)">–û—Ç–∫–∞–∑</p>`;
    }
  }, 1000);
}

// ===== –°–ë–û–† –†–ï–°–£–†–°–û–í =====
function renderGather() {
  const rt = S.event?.rt;
  if (!rt || !RES_ICON[rt]) return;

  const c = document.getElementById('eventCard');
  if (!c) return;

  c.innerHTML = `<div class="event-icon res">${RES_ICON[rt]}</div><div class="event-title">–°–±–æ—Ä ${rt === 'wood' ? '–¥–µ—Ä–µ–≤–∞' : rt === 'metal' ? '—Ä—É–¥—ã' : rt === 'cloth' ? '–≤–æ–ª–æ–∫–æ–Ω' : '–∫–æ–∂–∏'}</div><div class="event-stats"><span style="color:var(--accent)">–û—Å—Ç–∞–ª–æ—Å—å: ${S.gatherLeft}</span></div><div class="event-acts"><button class="btn btn-p" id="gatherBtn" onmousedown="startGather()" onmouseup="stopGather()" onmouseleave="stopGather()">–°–æ–±–∏—Ä–∞—Ç—å</button></div>`;
}

let gatherInterval = null;
let gatherProgress = 0;
const GATHER_TIME = 1000;

function startGather() {
  if (gatherInterval || !S.event?.rt) return;

  gatherProgress = 0;
  gatherInterval = setInterval(() => {
    gatherProgress += 50;
    const prog = document.getElementById('stepProg');
    if (prog) prog.style.width = (gatherProgress / GATHER_TIME * 100) + '%';

    if (gatherProgress >= GATHER_TIME) {
      stopGather();
      S.gatherLeft--;

      const rt = S.event.rt;
      if (S.p.res[rt] !== undefined) {
        S.p.res[rt]++;
      }

      if (S.gatherLeft <= 0) {
        S.event = null;
        genEvent();
      } else {
        renderGather();
      }

      updHdr();
      saveGame();
    }
  }, 50);
}

function stopGather() {
  if (gatherInterval) {
    clearInterval(gatherInterval);
    gatherInterval = null;
  }
  gatherProgress = 0;
  const prog = document.getElementById('stepProg');
  if (prog) prog.style.width = '0';
}

// ===== –ë–û–ô =====
function attackPlayer() {
  if (!S.event?.data) return;
  const pl = S.event.data;
  S.combat = {...pl, hp: pl.hp, maxHp: pl.hp, isPvP: 1};
  startCombatUI();
}

function startCombat() {
  if (!S.event?.data) return;
  const e = S.event.data;
  S.combat = {...e, hp: e.hp, maxHp: e.hp};
  startCombatUI();
}

function startCombatUI() {
  const eventCard = document.getElementById('eventCard');
  const combatCard = document.getElementById('combatCard');
  const enemyAva = document.getElementById('cEnemyAva');
  const enemyName = document.getElementById('cEnemyName');
  const turnInd = document.getElementById('turnInd');
  const combatLog = document.getElementById('combatLog');

  if (eventCard) eventCard.style.display = 'none';
  if (combatCard) combatCard.style.display = 'block';
  if (enemyAva) enemyAva.textContent = S.combat.icon || 'üë§';
  if (enemyName) enemyName.textContent = S.combat.name;

  S.turn = 'player';
  updCombat();
  renderAbils();
  if (combatLog) combatLog.innerHTML = '';
  if (turnInd) turnInd.textContent = '–í–∞—à —Ö–æ–¥';
}

function updCombat() {
  const c = S.combat;
  if (!c) return;

  const enemyHp = document.getElementById('cEnemyHp');
  const enemyHpTxt = document.getElementById('cEnemyHpTxt');
  const playerHp = document.getElementById('cPlayerHp');
  const playerHpTxt = document.getElementById('cPlayerHpTxt');

  if (enemyHp) enemyHp.style.width = (c.hp / c.maxHp * 100) + '%';
  if (enemyHpTxt) enemyHpTxt.textContent = `${Math.max(0, c.hp)}/${c.maxHp}`;
  if (playerHp) playerHp.style.width = (S.p.hp / S.p.maxHp * 100) + '%';
  if (playerHpTxt) playerHpTxt.textContent = `${S.p.hp}/${S.p.maxHp}`;

  updHdr();
}

function renderAbils() {
  const eq = S.p.eq;
  let abs = [];

  if (eq.mainHand && ITEMS[eq.mainHand]) {
    ITEMS[eq.mainHand].ab.forEach(a => abs.push({key: a, ...ABILS[a]}));
  } else {
    abs.push({key: 'punch', ...ABILS.punch});
  }

  if (eq.offHand && ITEMS[eq.offHand]) {
    ITEMS[eq.offHand].ab.forEach(a => abs.push({key: a, ...ABILS[a]}));
  }
  if (eq.chest && ITEMS[eq.chest]) {
    ITEMS[eq.chest].ab.forEach(a => abs.push({key: a, ...ABILS[a]}));
  }
  if (eq.boots && ITEMS[eq.boots]) {
    ITEMS[eq.boots].ab.forEach(a => abs.push({key: a, ...ABILS[a]}));
  }

  while (abs.length < 4) abs.push({key: 'wait', ...ABILS.wait});
  abs = abs.slice(0, 4);

  const grid = document.getElementById('abilGrid');
  if (!grid) return;

  grid.innerHTML = abs.map(a =>
    `<button class="abil-btn" onclick="useAbil('${a.key}')" ${S.turn !== 'player' ? 'disabled' : ''}>
      <div class="abil-name">${a.icon} ${a.name}</div>
      <div class="abil-desc">${a.desc}</div>
    </button>`
  ).join('');
}

function useAbil(k) {
  if (S.turn !== 'player' || !S.combat) return;

  const a = ABILS[k];
  const c = S.combat;
  const log = document.getElementById('combatLog');
  const turnInd = document.getElementById('turnInd');

  if (!a || !c) return;

  S.turn = 'wait';
  if (turnInd) turnInd.textContent = '...';
  renderAbils();

  setTimeout(() => {
    if (a.dmg) {
      c.hp -= a.dmg;
      if (log) log.innerHTML += `<div class="log-dmg">‚Üí${a.name}: ${a.dmg}</div>`;
    }
    if (a.heal) {
      S.p.hp = Math.min(S.p.maxHp, S.p.hp + a.heal);
      if (log) log.innerHTML += `<div class="log-heal">‚Üí${a.name}: +${a.heal}</div>`;
    }

    updCombat();
    saveGame();

    if (c.hp <= 0) {
      endCombat(1);
      return;
    }

    S.turn = 'enemy';
    if (turnInd) turnInd.textContent = '–•–æ–¥ –≤—Ä–∞–≥–∞';

    setTimeout(() => {
      const dmg = c.dmg || 10;
      S.p.hp -= dmg;
      if (log) log.innerHTML += `<div class="log-dmg">‚Üê${c.name}: ${dmg}</div>`;
      updCombat();

      if (S.p.hp <= 0) {
        S.p.hp = 1;
        endCombat(0);
        return;
      }

      S.turn = 'player';
      if (turnInd) turnInd.textContent = '–í–∞—à —Ö–æ–¥';
      renderAbils();
    }, 1000);
  }, 500);
}

function endCombat(won) {
  const eventCard = document.getElementById('eventCard');
  const combatCard = document.getElementById('combatCard');
  const log = document.getElementById('combatLog');

  if (combatCard) combatCard.style.display = 'none';
  if (eventCard) eventCard.style.display = 'block';

  if (won) {
    let loot = '';
    const hasKnife = S.p.inv.includes('skinning_knife') || S.p.eq.tool === 'skinning_knife';

    const c = S.combat;
    if (c.xp) {
      const cat = S.p.eq.mainHand && ITEMS[S.p.eq.mainHand]?.cat || 'sword';
      if (!S.p.mast[cat]) S.p.mast[cat] = {lv: 1, xp: 0};
      S.p.mast[cat].xp += c.xp;
      while (S.p.mast[cat].xp >= S.p.mast[cat].lv * 50) {
        S.p.mast[cat].xp -= S.p.mast[cat].lv * 50;
        S.p.mast[cat].lv++;
      }
    }
    if (c.loot) {
      c.loot.forEach(l => {
        if (ITEMS[l]) {
          S.p.inv.push(l);
          loot += `<div>üéÅ${ITEMS[l].name}</div>`;
        } else if (l === 'leather') {
          if (hasKnife) {
            S.p.res.leather++;
            loot += `<div>${RES_ICON.leather}+1</div>`;
          } else {
            loot += `<div style="color:var(--muted)">–ù—É–∂–µ–Ω –Ω–æ–∂ –¥–ª—è –∫–æ–∂–∏</div>`;
          }
        } else {
          if (S.p.res[l] !== undefined) {
            S.p.res[l]++;
            loot += `<div>${RES_ICON[l]}+1</div>`;
          }
        }
      });
    }

    const gold = Math.floor(Math.random() * 15) + 5;
    S.p.gold += gold;

    if (eventCard) {
      eventCard.innerHTML = `<div class="event-icon res">üéâ</div><div class="event-title">–ü–æ–±–µ–¥–∞!</div><div style="color:var(--ok);margin:8px">${loot}<div style="color:var(--accent)">üí∞+${gold}</div></div>`;
    }
  } else {
    const c = S.combat;
    const isPvP = c?.isPvP;
    const L = LOCS[S.loc];

    if (isPvP && L?.pvp === 'open') {
      S.p.eq = {mainHand: null, offHand: null, chest: null, boots: null, tool: null};
      S.p.inv = [];
      S.p.res = {wood: 0, metal: 0, cloth: 0, leather: 0};
      if (eventCard) eventCard.innerHTML = `<div class="event-icon enemy">üíÄ</div><div class="event-title">PvP —Å–º–µ—Ä—Ç—å!</div><p style="color:var(--bad)">–í—Å—ë –ø–æ—Ç–µ—Ä—è–Ω–æ!</p>`;
    } else {
      if (log) log.innerHTML += `<div class="log-dmg">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ...</div>`;
    }
    S.p.hp = Math.floor(S.p.maxHp * 0.5);
    goTo('city');
  }

  S.combat = null;
  S.event = null;
  saveGame();
  genEvent();
}

// ===== –õ–û–ö–ê–¶–ò–ò =====
function renderLocList() {
  const list = document.getElementById('locList');
  if (!list) return;

  let h = '';
  for (const [k, L] of Object.entries(LOCS)) {
    const canGo = k === 'city' || S.openedLocs.includes(k);
    const isCurrent = k === S.loc;

    h += `<div class="loc-item ${!canGo ? 'locked' : isCurrent ? 'current' : ''}" onclick="${canGo ? `goTo('${k}')` : ''}">
      <div class="loc-icon">${L.icon}</div>
      <div class="loc-info">
        <div class="loc-name">${L.name}</div>
        <div class="loc-desc">${L.isCity ? '–ì–æ—Ä–æ–¥' : `–£—Ä–æ–≤–µ–Ω—å ${L.tier}`}</div>
      </div>
      ${canGo ? (isCurrent ? '<div class="loc-badge">–¢–µ–∫—É—â–∞—è</div>' : `<button class="btn btn-s btn-sm" onclick="fastTravel('${k}'); event.stopPropagation()">üöÄ</button>`) : '<div class="loc-badge locked">üîí</div>'}
    </div>`;
  }
  list.innerHTML = h;
}

// ===== –ì–û–†–û–î =====
function renderCity() {
  cityTab('craft');
}

function cityTab(t) {
  document.querySelectorAll('.city-tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.city-panel').forEach(x => x.classList.remove('active'));

  const tab = document.querySelector(`[onclick="cityTab('${t}')"]`);
  const panel = document.getElementById('city' + t.charAt(0).toUpperCase() + t.slice(1));

  if (tab) tab.classList.add('active');
  if (panel) panel.classList.add('active');

  if (t === 'craft') renderCraft();
  if (t === 'bank') renderBank();
  if (t === 'auc') renderAuc();
}

function renderCraft() {
  const grid = document.getElementById('craftGrid');
  if (!grid) return;

  let h = '';
  for (const [k, r] of Object.entries(RECIPES)) {
    const it = ITEMS[k];
    if (!it) continue;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã
    let canCraft = true;
    let cost = '';
    for (const [res, amt] of Object.entries(r)) {
      cost += `${RES_ICON[res]}${amt} `;
      if ((S.p.res[res] || 0) < amt) canCraft = false;
    }

    h += `<div class="craft-item ${!canCraft ? 'disabled' : ''}">
      <div class="craft-icon">${it.icon}</div>
      <div class="craft-info">
        <div class="craft-name">${it.name}</div>
        <div class="craft-cost">${cost.trim()}</div>
      </div>
      <button class="btn btn-p btn-sm" onclick="craft('${k}')" ${!canCraft ? 'disabled' : ''}>–°–æ–∑–¥–∞—Ç—å</button>
    </div>`;
  }
  grid.innerHTML = h;
}

function craft(k) {
  const r = RECIPES[k];
  if (!r) return;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
  for (const [res, amt] of Object.entries(r)) {
    if ((S.p.res[res] || 0) < amt) return;
  }

  // –¢—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã
  for (const [res, amt] of Object.entries(r)) {
    S.p.res[res] -= amt;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç
  S.p.inv.push(k);
  renderCraft();
  renderInv();
  updHdr();
  saveGame();
}

// ===== –ë–ê–ù–ö =====
function renderBank() {
  renderBankRes();
  renderBankItems();
}

function renderBankRes() {
  const grid = document.getElementById('bankResGrid');
  if (!grid) return;

  let h = '';
  for (const [res, amt] of Object.entries(S.p.res)) {
    const icon = RES_ICON[res];
    const bankAmt = S.p.bank.res[res] || 0;

    h += `<div class="bank-item">
      <div class="bank-icon">${icon}</div>
      <div class="bank-info">
        <div class="bank-name">${res === 'wood' ? '–î–µ—Ä–µ–≤–æ' : res === 'metal' ? '–ú–µ—Ç–∞–ª–ª' : res === 'cloth' ? '–¢–∫–∞–Ω—å' : '–ö–æ–∂–∞'}</div>
        <div class="bank-amt">–£ –≤–∞—Å: ${amt} | –í –±–∞–Ω–∫–µ: ${bankAmt}</div>
      </div>
      <div class="bank-acts">
        <button class="btn btn-s btn-sm" onclick="depositRes('${res}')" ${amt <= 0 ? 'disabled' : ''}>‚Üí</button>
        <button class="btn btn-s btn-sm" onclick="withdrawRes('${res}')" ${bankAmt <= 0 ? 'disabled' : ''}>‚Üê</button>
      </div>
    </div>`;
  }
  grid.innerHTML = h;
}

function depositRes(res) {
  if (S.p.res[res] <= 0) return;
  S.p.res[res]--;
  S.p.bank.res[res] = (S.p.bank.res[res] || 0) + 1;
  renderBankRes();
  saveGame();
}

function withdrawRes(res) {
  const bankAmt = S.p.bank.res[res] || 0;
  if (bankAmt <= 0) return;
  S.p.res[res] = (S.p.res[res] || 0) + 1;
  S.p.bank.res[res]--;
  renderBankRes();
  saveGame();
}

function renderBankItems() {
  const grid = document.getElementById('bankItemsGrid');
  if (!grid) return;

  let h = '';
  const allItems = [...new Set([...S.p.inv, ...S.p.bank.items])];

  for (const ik of allItems) {
    const it = ITEMS[ik];
    if (!it) continue;

    const invCount = S.p.inv.filter(i => i === ik).length;
    const bankCount = S.p.bank.items.filter(i => i === ik).length;

    h += `<div class="bank-item">
      <div class="bank-icon">${it.icon}</div>
      <div class="bank-info">
        <div class="bank-name">${it.name}</div>
        <div class="bank-amt">–£ –≤–∞—Å: ${invCount} | –í –±–∞–Ω–∫–µ: ${bankCount}</div>
      </div>
      <div class="bank-acts">
        <button class="btn btn-s btn-sm" onclick="depositItem('${ik}')" ${invCount <= 0 ? 'disabled' : ''}>‚Üí</button>
        <button class="btn btn-s btn-sm" onclick="withdrawItem('${ik}')" ${bankCount <= 0 ? 'disabled' : ''}>‚Üê</button>
      </div>
    </div>`;
  }
  grid.innerHTML = h;
}

function depositItem(ik) {
  const idx = S.p.inv.indexOf(ik);
  if (idx === -1) return;

  S.p.inv.splice(idx, 1);
  S.p.bank.items.push(ik);
  renderBankItems();
  renderInv();
  saveGame();
}

function withdrawItem(ik) {
  const idx = S.p.bank.items.indexOf(ik);
  if (idx === -1) return;

  S.p.bank.items.splice(idx, 1);
  S.p.inv.push(ik);
  renderBankItems();
  renderInv();
  saveGame();
}

// ===== –ê–£–ö–¶–ò–û–ù =====
function renderAuc() {
  renderAucItems();
  renderAucSell();
}

function renderAucItems() {
  const grid = document.getElementById('aucItemsGrid');
  if (!grid) return;

  let h = '<div class="auc-tabs">';
  const cats = ['all', 'weapon', 'armor', 'tool'];
  for (const cat of cats) {
    h += `<button class="auc-tab" onclick="toggleAucGroup('${cat}')">${cat === 'all' ? '–í—Å–µ' : cat === 'weapon' ? '–û—Ä—É–∂–∏–µ' : cat === 'armor' ? '–ë—Ä–æ–Ω—è' : '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã'}</button>`;
  }
  h += '</div>';

  h += '<div class="auc-items" id="aucItems">';
  // –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–æ–≤–∞—Ä—ã
  h += '</div>';

  grid.innerHTML = h;
  toggleAucGroup('all');
}

function toggleAucGroup(cat) {
  document.querySelectorAll('.auc-tab').forEach(x => x.classList.remove('active'));
  const tab = Array.from(document.querySelectorAll('.auc-tab')).find(x => x.textContent === (cat === 'all' ? '–í—Å–µ' : cat === 'weapon' ? '–û—Ä—É–∂–∏–µ' : cat === 'armor' ? '–ë—Ä–æ–Ω—è' : '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã'));
  if (tab) tab.classList.add('active');

  const items = document.getElementById('aucItems');
  if (!items) return;

  let h = '';
  const aucItems = [
    {item: 'iron_sword', price: 25},
    {item: 'wooden_bow', price: 15},
    {item: 'cloth_robe', price: 20},
    {item: 'leather_armor', price: 30},
    {item: 'pickaxe', price: 10}
  ];

  for (const ai of aucItems) {
    const it = ITEMS[ai.item];
    if (!it) continue;

    let show = cat === 'all';
    if (!show) {
      if (cat === 'weapon' && (it.slot === 'mainHand' || it.slot === 'offHand')) show = true;
      if (cat === 'armor' && (it.slot === 'chest' || it.slot === 'boots')) show = true;
      if (cat === 'tool' && it.slot === 'tool') show = true;
    }

    if (show) {
      h += `<div class="auc-item">
        <div class="auc-icon">${it.icon}</div>
        <div class="auc-info">
          <div class="auc-name">${it.name}</div>
          <div class="auc-price">üí∞${ai.price}</div>
        </div>
        <button class="btn btn-p btn-sm" onclick="buyAuc('${ai.item}', ${ai.price})" ${S.p.gold < ai.price ? 'disabled' : ''}>–ö—É–ø–∏—Ç—å</button>
      </div>`;
    }
  }
  items.innerHTML = h;
}

function renderAucSell() {
  const grid = document.getElementById('aucSellGrid');
  if (!grid) return;

  let h = '';
  for (const ik of S.p.inv) {
    const it = ITEMS[ik];
    if (!it) continue;

    h += `<div class="auc-sell-item">
      <div class="auc-icon">${it.icon}</div>
      <div class="auc-info">
        <div class="auc-name">${it.name}</div>
        <div class="auc-price">üí∞${Math.floor(Math.random() * 10) + 5}</div>
      </div>
      <button class="btn btn-s btn-sm" onclick="showSell('${ik}')">–ü—Ä–æ–¥–∞—Ç—å</button>
    </div>`;
  }
  grid.innerHTML = h;
}

function showSell(ik) {
  const modTitle = document.getElementById('modTitle');
  const modContent = document.getElementById('modContent');
  const modal = document.getElementById('modal');

  const it = ITEMS[ik];
  const price = Math.floor(Math.random() * 10) + 5;

  if (modTitle) modTitle.textContent = '–ü—Ä–æ–¥–∞–∂–∞';
  if (modContent) modContent.innerHTML = `
    <p>–ü—Ä–æ–¥–∞—Ç—å ${it.icon} ${it.name} –∑–∞ üí∞${price}?</p>
    <button class="btn btn-p" onclick="sellAuc('${ik}', ${price})">–î–∞</button>
    <button class="btn btn-s" onclick="closeMod()">–ù–µ—Ç</button>
  `;
  if (modal) modal.classList.add('active');
}

function sellAuc(ik, price) {
  const idx = S.p.inv.indexOf(ik);
  if (idx === -1) return;

  S.p.inv.splice(idx, 1);
  S.p.gold += price;
  renderAucSell();
  renderInv();
  updHdr();
  closeMod();
  saveGame();
}

function buyAuc(ik, price) {
  if (S.p.gold < price) return;

  S.p.gold -= price;
  S.p.inv.push(ik);
  toggleAucGroup(document.querySelector('.auc-tab.active')?.textContent === '–í—Å–µ' ? 'all' : document.querySelector('.auc-tab.active')?.textContent === '–û—Ä—É–∂–∏–µ' ? 'weapon' : document.querySelector('.auc-tab.active')?.textContent === '–ë—Ä–æ–Ω—è' ? 'armor' : 'tool');
  renderInv();
  updHdr();
  saveGame();
}

// ===== –ò–ù–í–ï–ù–¢–ê–†–¨ =====
function renderInv() {
  const grid = document.getElementById('invGrid');
  if (!grid) return;

  let h = '';
  const eq = S.p.eq;

  // –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞
  h += `<div class="inv-section">
    <div class="inv-title">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div>
    <div class="inv-eq">
      <div class="eq-slot">
        <div class="eq-label">–ì–ª–∞–≤–Ω–∞—è —Ä—É–∫–∞</div>
        <div class="eq-item" onclick="itemMod('${eq.mainHand || ''}', -1)">
          ${eq.mainHand ? ITEMS[eq.mainHand].icon + ' ' + ITEMS[eq.mainHand].name : '–ü—É—Å—Ç–æ'}
        </div>
      </div>
      <div class="eq-slot">
        <div class="eq-label">–í—Ç–æ—Ä–∞—è —Ä—É–∫–∞</div>
        <div class="eq-item" onclick="itemMod('${eq.offHand || ''}', -1)">
          ${eq.offHand ? ITEMS[eq.offHand].icon + ' ' + ITEMS[eq.offHand].name : '–ü—É—Å—Ç–æ'}
        </div>
      </div>
      <div class="eq-slot">
        <div class="eq-label">–ë—Ä–æ–Ω—è</div>
        <div class="eq-item" onclick="itemMod('${eq.chest || ''}', -1)">
          ${eq.chest ? ITEMS[eq.chest].icon + ' ' + ITEMS[eq.chest].name : '–ü—É—Å—Ç–æ'}
        </div>
      </div>
      <div class="eq-slot">
        <div class="eq-label">–û–±—É–≤—å</div>
        <div class="eq-item" onclick="itemMod('${eq.boots || ''}', -1)">
          ${eq.boots ? ITEMS[eq.boots].icon + ' ' + ITEMS[eq.boots].name : '–ü—É—Å—Ç–æ'}
        </div>
      </div>
      <div class="eq-slot">
        <div class="eq-label">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
        <div class="eq-item" onclick="itemMod('${eq.tool || ''}', -1)">
          ${eq.tool ? ITEMS[eq.tool].icon + ' ' + ITEMS[eq.tool].name : '–ü—É—Å—Ç–æ'}
        </div>
      </div>
    </div>
  </div>`;

  // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
  h += `<div class="inv-section">
    <div class="inv-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
    <div class="inv-items">`;

  for (let i = 0; i < S.p.inv.length; i++) {
    const ik = S.p.inv[i];
    const it = ITEMS[ik];
    if (!it) continue;

    h += `<div class="inv-item" onclick="itemMod('${ik}', ${i})">
      <div class="inv-icon">${it.icon}</div>
      <div class="inv-name">${it.name}</div>
    </div>`;
  }

  h += `</div></div>`;
  grid.innerHTML = h;
}

function itemMod(ik, idx) {
  if (!ik) return;

  const it = ITEMS[ik];
  if (!it) return;

  const modTitle = document.getElementById('modTitle');
  const modContent = document.getElementById('modContent');
  const modal = document.getElementById('modal');

  if (modTitle) modTitle.textContent = it.name;
  if (modContent) {
    let content = `<div style="text-align:center;margin-bottom:16px">${it.icon} ${it.name}</div>`;
    content += `<div style="color:var(--dim);margin-bottom:16px">${it.desc}</div>`;

    if (it.slot) {
      const isEquipped = S.p.eq[it.slot] === ik;
      content += `<button class="btn ${isEquipped ? 'btn-s' : 'btn-p'}" onclick="${isEquipped ? 'unequip' : 'equip'}('${ik}')">${isEquipped ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å'}</button>`;
    }

    if (idx >= 0) {
      content += `<button class="btn btn-d" onclick="S.p.inv.splice(${idx}, 1); renderInv(); saveGame(); closeMod()">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>`;
    }

    modContent.innerHTML = content;
  }
  if (modal) modal.classList.add('active');
}

function equip(ik) {
  const it = ITEMS[ik];
  if (!it || !it.slot) return;

  S.p.eq[it.slot] = ik;
  renderInv();
  updHdr();
  closeMod();
  saveGame();
}

function unequip(ik) {
  const it = ITEMS[ik];
  if (!it || !it.slot) return;

  S.p.eq[it.slot] = null;
  renderInv();
  updHdr();
  closeMod();
  saveGame();
}

// ===== –ú–ê–°–¢–ï–†–°–¢–í–û =====
function renderMast() {
  const grid = document.getElementById('mastGrid');
  if (!grid) return;

  let h = '';
  const cats = {
    sword: '–ú–µ—á', bow: '–õ—É–∫', staff: '–ü–æ—Å–æ—Ö',
    cloth: '–¢–∫–∞–Ω—å', leather: '–ö–æ–∂–∞', plate: '–õ–∞—Ç—ã'
  };

  for (const [k, name] of Object.entries(cats)) {
    const m = S.p.mast[k] || {lv: 1, xp: 0};
    const nextXp = m.lv * 50;

    h += `<div class="mast-item">
      <div class="mast-icon">${k === 'sword' ? '‚öîÔ∏è' : k === 'bow' ? 'üèπ' : k === 'staff' ? 'ü™Ñ' : k === 'cloth' ? 'üëò' : k === 'leather' ? 'ü¶∫' : 'üõ°Ô∏è'}</div>
      <div class="mast-info">
        <div class="mast-name">${name}</div>
        <div class="mast-lv">–£—Ä–æ–≤–µ–Ω—å ${m.lv}</div>
      </div>
      <div class="mast-xp">
        <div class="xp-bar">
          <div class="xp-fill" style="width:${(m.xp / nextXp * 100)}%"></div>
        </div>
        <div class="xp-text">${m.xp}/${nextXp}</div>
      </div>
    </div>`;
  }
  grid.innerHTML = h;
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
let tg = null;

function initTelegram() {
  if (window.Telegram?.WebApp) {
    tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#23272f');
    tg.setBackgroundColor('#1a1d23');
  }
  return tg;
}

function updatePlayerName() {
  if (tg?.initDataUnsafe?.user) {
    const user = tg.initDataUnsafe.user;
    const nameEl = document.getElementById('hdrName');
    const avatarEl = document.getElementById('avatar');
    if (nameEl) nameEl.textContent = user.first_name || '–ò–≥—Ä–æ–∫';
    if (avatarEl) avatarEl.textContent = user.first_name?.[0] || 'üë§';
  }
}

function initGame() {
  try {
    initGameState();
    initTelegram();
    updatePlayerName();
    updHdr();
    renderMap();
    genEvent();

    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç–∫—Ä–∞–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
    const exploreScreen = document.getElementById('sExplore');
    if (exploreScreen) {
      exploreScreen.classList.add('active');
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã:", error);
    const modTitle = document.getElementById('modTitle');
    const modContent = document.getElementById('modContent');
    const modal = document.getElementById('modal');

    if (modTitle) modTitle.textContent = '–û—à–∏–±–∫–∞';
    if (modContent) modContent.innerHTML = `<p style="color:var(--bad);">${error.message}</p><button class="btn btn-p" style="width:100%;margin-top:12px" onclick="closeMod()">–û–ö</button>`;
    if (modal) modal.classList.add('active');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', initGame);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
window.cityTab = cityTab;
window.startStep = startStep;
window.stopStep = stopStep;
window.nav = nav;
window.renderInv = renderInv;
window.renderLocList = renderLocList;
window.renderCity = renderCity;
window.renderMast = renderMast;
window.wave = wave;
window.duel = duel;
window.genEvent = genEvent;
window.startCombat = startCombat;
window.attackPlayer = attackPlayer;
window.useAbil = useAbil;
window.goTo = goTo;
window.fastTravel = fastTravel;
window.restartLocation = restartLocation;
window.goToNextLocation = goToNextLocation;
window.craft = craft;
window.depositRes = depositRes;
window.withdrawRes = withdrawRes;
window.depositItem = depositItem;
window.withdrawItem = withdrawItem;
window.toggleAucGroup = toggleAucGroup;
window.showSell = showSell;
window.sellAuc = sellAuc;
window.buyAuc = buyAuc;
window.itemMod = itemMod;
window.equip = equip;
window.unequip = unequip;
window.closeMod = closeMod;
</script>
<script>
// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
const $ = id => document.getElementById(id);
</script>
  city: {name: '–ì–æ—Ä–æ–¥', icon: 'üè∞', tier: 0, pvp: 'safe', isCity: 1, nodes: [{x: 50, y: 50}], paths: [], exits: {}},
  meadow: {name: '–õ—É–≥–∞', icon: 'üåø', tier: 1, pvp: 'request', nodes: [{x: 20, y: 80}, {x: 40, y: 60}, {x: 60, y: 40}, {x: 50, y: 70}, {x: 80, y: 30}], paths: [[0, 1], [1, 2], [1, 3], [2, 4], [3, 4]], enemies: ['slime', 'wolf'], res: ['wood', 'cloth'], exits: {4: 'forest'}},
  forest: {name: '–õ–µ—Å', icon: 'üå≤', tier: 2, pvp: 'request', nodes: [{x: 20, y: 30}, {x: 40, y: 50}, {x: 30, y: 70}, {x: 60, y: 40}, {x: 80, y: 60}, {x: 70, y: 80}], paths: [[0, 1], [1, 2], [1, 3], [3, 4], [2, 5], [4, 5]], enemies: ['wolf', 'bear'], res: ['wood', 'leather'], exits: {0: 'meadow', 5: 'highlands'}},
  highlands: {name: '–í—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ', icon: '‚õ∞Ô∏è', tier: 3, pvp: 'open', nodes: [{x: 50, y: 20}, {x: 30, y: 40}, {x: 70, y: 40}, {x: 40, y: 60}, {x: 60, y: 60}, {x: 50, y: 80}], paths: [[0, 1], [0, 2], [1, 3], [2, 4], [3, 5], [4, 5]], enemies: ['golem', 'harpy'], res: ['metal', 'leather'], exits: {0: 'forest'}}
};

const ENEMIES = {
  slime: {name: '–°–ª–∏–∑–µ–Ω—å', icon: 'üü¢', hp: 30, dmg: 5, xp: 10, loot: ['cloth']},
  wolf: {name: '–í–æ–ª–∫', icon: 'üê∫', hp: 50, dmg: 10, xp: 20, loot: ['leather']},
  bear: {name: '–ú–µ–¥–≤–µ–¥—å', icon: 'üêª', hp: 80, dmg: 15, xp: 35, loot: ['leather', 'leather']},
  golem: {name: '–ì–æ–ª–µ–º', icon: 'üóø', hp: 120, dmg: 18, xp: 50, loot: ['metal', 'metal']},
  harpy: {name: '–ì–∞—Ä–ø–∏—è', icon: 'ü¶Ö', hp: 60, dmg: 20, xp: 45, loot: ['cloth']}
};

const PLAYERS = [
  {name: '–†—ã—Ü–∞—Ä—å_42', hp: 80, dmg: 15, loot: ['iron_sword']},
  {name: 'MagicUser', hp: 60, dmg: 20, loot: ['wooden_staff']},
  {name: '–û—Ö–æ—Ç–Ω–∏–∫', hp: 70, dmg: 18, loot: ['wooden_bow']}
];

</script>
</body>
</html>
